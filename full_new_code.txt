// FILE: .gitignore
// --------------------------------------------------------------------------

# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*
lerna-debug.log*

node_modules
dist
dist-ssr
*.local

# Editor directories and files
.vscode/*
!.vscode/extensions.json
.idea
.DS_Store
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?


// END OF FILE: .gitignore
// ==========================================================================

// FILE: App.tsx
// --------------------------------------------------------------------------

// FILE: App.tsx
// --------------------------------------------------------------------------

import React, { useState, useEffect } from 'react';
import { Routes, Route, useNavigate, Link, useLocation } from 'react-router-dom';
import { SignedIn, SignedOut, UserButton, useUser } from '@clerk/clerk-react';
import { supabase } from './src/lib/supabase';

// Components & Pages
import Blackboard from './components/Blackboard';
import LessonPage from './pages/LessonPage';
import NotesPage from './pages/NotesPage';
import ArchivePage from './pages/ArchivePage';
import NoticeBoard from './pages/NoticeBoard';
import WelcomePage from './pages/WelcomePage';
import CoursesPage from './pages/CoursesPage';
import CourseDetailPage from './pages/CourseDetailPage';
import TestPage from './pages/TestPage';
import ProfilePage from './pages/ProfilePage';

const App: React.FC = () => {
  const { user, isLoaded, isSignedIn } = useUser();
  const navigate = useNavigate();
  const location = useLocation();

  const [topic, setTopic] = useState('');
  const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
  
  // 1. Sync User to Supabase (Non-blocking)
  useEffect(() => {
    const syncUser = async () => {
      if (isLoaded && isSignedIn && user) {
        // Sync profile to Supabase silently
        await supabase
          .from('students')
          .upsert({
            student_id: user.id,
            full_name: user.fullName || user.username || "Seeker Student",
            email: user.primaryEmailAddress?.emailAddress,
            profile_image_url: user.imageUrl,
          }, {
            onConflict: 'student_id'
          });
      }
    };

    syncUser();
  }, [isLoaded, isSignedIn, user]);

  // 2. Start Lesson Handler
  const handleStartLesson = () => {
    if (!topic.trim()) return;
    const lessonUuid = crypto.randomUUID();
    navigate(`/lesson/${lessonUuid}`, { state: { topic } });
    setTopic('');
    setMobileMenuOpen(false); // Close mobile menu after starting lesson
  };

  // 3. Loading State (Only for Clerk Auth)
  if (!isLoaded) {
    return (
      <div className="h-screen bg-[#1e3a2f] flex flex-col items-center justify-center">
        <div className="w-12 h-12 border-4 border-yellow-400 border-t-transparent rounded-full animate-spin mb-4" />
      </div>
    );
  }

  return (
    <div className={`flex flex-col h-screen w-full text-white font-sans ${location.pathname === '/archive' ? 'bg-[#f4f1ea]' : 'bg-[#1a1a1a]'}`} style={{ overflow: location.pathname === '/archive' || location.pathname === '/profile' ? 'auto' : 'hidden' }}>

      {/* GLOBAL HEADER */}
      <SignedIn>
        <header className="p-4 md:px-8 border-b border-white/10 bg-[#1e1e1e]/50 backdrop-blur-xl flex items-center justify-between font-bold text-xl uppercase tracking-tight z-50">
          
          {/* Logo - Always Visible */}
          <Link to="/" className="flex items-center gap-3 hover:opacity-80 transition-opacity">
            <div className="w-10 h-10 bg-yellow-400 rounded-xl flex items-center justify-center border border-white/20">
              <span className="material-symbols-outlined text-[#1e3a2f] font-bold">school</span>
            </div>
            <span className="marker-font text-yellow-400 lowercase hidden sm:block">seeker</span>
          </Link>

          {/* Desktop Navigation */}
          <nav className="hidden lg:flex items-center gap-6 border-l border-white/10 pl-8">
            <Link to="/notice-board" className="text-[10px] tracking-[0.2em] text-white/40 hover:text-yellow-500 transition-colors uppercase">Notice Board</Link>
            <Link to="/archive" className="text-[10px] tracking-[0.2em] text-white/40 hover:text-green-500 transition-colors uppercase">My Lessons</Link>
            <Link to="/courses" className="text-[10px] tracking-[0.2em] text-white/40 hover:text-blue-500 transition-colors uppercase">My Courses</Link>
          </nav>

          {/* Mobile Menu Button */}
          <button 
            onClick={() => setMobileMenuOpen(!mobileMenuOpen)}
            className="lg:hidden text-white/60 hover:text-white p-2 transition-colors"
          >
            <span className="material-symbols-outlined text-3xl">
              {mobileMenuOpen ? 'close' : 'menu'}
            </span>
          </button>

          {/* Desktop Search & User */}
          <div className="hidden lg:flex items-center gap-4 flex-1 justify-end max-w-2xl px-4">
            <div className="flex gap-2 w-full">
              <input
                type="text"
                value={topic}
                onChange={(e) => setTopic(e.target.value)}
                onKeyDown={(e) => e.key === 'Enter' && handleStartLesson()}
                placeholder={`What would you like to learn, ${user?.firstName}?`}
                className="bg-white/5 border border-white/10 rounded-full px-5 py-2 text-sm focus:ring-2 focus:ring-yellow-500 transition-all font-normal flex-1 outline-none handwritten text-lg"
              />
              <button
                onClick={handleStartLesson}
                className="bg-yellow-400 text-[#1e3a2f] px-6 py-2 rounded-full text-[10px] hover:bg-yellow-300 transition-all uppercase tracking-widest font-black"
              >
                Start
              </button>
            </div>
            <div className="ml-2 pl-4 border-l border-white/10 flex items-center gap-3">
              <Link to="/profile" className="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center hover:bg-white/20 transition-colors" title="Student Profile">
                <span className="material-symbols-outlined text-sm">settings</span>
              </Link>
              <UserButton afterSignOutUrl="/" />
            </div>
          </div>

          {/* Mobile User Button (Top Right) */}
          <div className="lg:hidden flex items-center gap-2">
            <Link to="/profile" className="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center hover:bg-white/20 transition-colors">
              <span className="material-symbols-outlined text-sm">settings</span>
            </Link>
            <UserButton afterSignOutUrl="/" />
          </div>
        </header>

        {/* Mobile Menu Dropdown */}
        {mobileMenuOpen && (
          <div className="lg:hidden bg-[#1e1e1e] border-b border-white/10 px-4 py-6 space-y-4 z-40 animate-fade-in">
            {/* Mobile Search */}
            <div className="flex gap-2">
              <input
                type="text"
                value={topic}
                onChange={(e) => setTopic(e.target.value)}
                onKeyDown={(e) => e.key === 'Enter' && handleStartLesson()}
                placeholder={`Learn something new...`}
                className="bg-white/5 border border-white/10 rounded-full px-4 py-3 text-sm focus:ring-2 focus:ring-yellow-500 transition-all font-normal flex-1 outline-none handwritten text-lg"
              />
              <button
                onClick={handleStartLesson}
                className="bg-yellow-400 text-[#1e3a2f] px-5 py-3 rounded-full text-[10px] hover:bg-yellow-300 transition-all uppercase tracking-widest font-black shrink-0"
              >
                Go
              </button>
            </div>

            {/* Mobile Nav Links */}
            <nav className="flex flex-col gap-3 pt-4 border-t border-white/10">
              <Link 
                to="/notice-board" 
                onClick={() => setMobileMenuOpen(false)}
                className="flex items-center gap-3 text-base tracking-wider text-white/60 hover:text-yellow-500 transition-colors uppercase py-3 px-2 rounded-lg hover:bg-white/5"
              >
                <span className="text-2xl">üìå</span>
                <span>Notice Board</span>
              </Link>
              <Link 
                to="/archive" 
                onClick={() => setMobileMenuOpen(false)}
                className="flex items-center gap-3 text-base tracking-wider text-white/60 hover:text-green-500 transition-colors uppercase py-3 px-2 rounded-lg hover:bg-white/5"
              >
                <span className="text-2xl">üìö</span>
                <span>My Lessons</span>
              </Link>
              <Link 
                to="/courses" 
                onClick={() => setMobileMenuOpen(false)}
                className="flex items-center gap-3 text-base tracking-wider text-white/60 hover:text-blue-500 transition-colors uppercase py-3 px-2 rounded-lg hover:bg-white/5"
              >
                <span className="text-2xl">üéì</span>
                <span>My Courses</span>
              </Link>
            </nav>
          </div>
        )}
      </SignedIn>

      {/* MAIN CONTENT AREA */}
      <main className={`flex-1 flex flex-col relative min-h-0 ${location.pathname === '/archive' ? 'bg-[#f4f1ea]' : 'bg-[#161616]'}`} style={{ overflow: location.pathname === '/archive' || location.pathname === '/profile' ? 'visible' : 'hidden' }}>
        <Routes>
          {/* HOME ROUTE */}
          <Route path="/" element={
            <>
              <SignedIn>
                <div className="flex-1 flex flex-col">
                  <Blackboard
                    content={topic || "The classroom is quiet..."}
                    fullLesson=""
                    thoughts="Consulting student profile... Ready to tailor your lecture."
                    isWriting={false}
                    topic="Classroom Session"
                  />
                  <div className="absolute bottom-20 left-1/2 -translate-x-1/2 text-center pointer-events-none px-4">
                    <h2 className="marker-font text-3xl md:text-5xl text-white opacity-10 uppercase tracking-widest leading-none">Your Private Academy</h2>
                    <p className="handwritten text-xl md:text-2xl text-white/5 mt-4">Consult the board or start a new lecture above.</p>
                  </div>
                </div>
              </SignedIn>

              <SignedOut>
                <WelcomePage />
              </SignedOut>
            </>
          } />

          {/* PROTECTED APP ROUTES */}
          <Route path="/course/:courseId" element={<CourseDetailPage />} />
          <Route path="/test/:lessonPlanId" element={<TestPage />} />
          <Route path="/courses" element={<CoursesPage />} />
          <Route path="/notice-board" element={<NoticeBoard />} />
          <Route path="/archive" element={<ArchivePage />} />
          <Route path="/lesson/:lessonId" element={<LessonPage />} />
          <Route path="/notes/:lessonId" element={<NotesPage />} />
          <Route path="/profile" element={<ProfilePage />} />
        </Routes>
      </main>

      <style>{`
        .handwritten { font-family: 'Caveat', cursive; }
        .marker-font { font-family: 'Permanent Marker', cursive; }
        
        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(-10px); }
          to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
          animation: fadeIn 0.3s ease-out forwards;
        }

        /* Hide Scrollbar for cleaner UI */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
      `}</style>
    </div>
  );
};

export default App;

// END OF FILE: App.tsx

// END OF FILE: App.tsx
// ==========================================================================

// FILE: README.md
// --------------------------------------------------------------------------

<div align="center">
<img width="1200" height="475" alt="GHBanner" src="https://github.com/user-attachments/assets/0aa67016-6eaf-458a-adb2-6e31a0763ed6" />
</div>

# Run and deploy your AI Studio app

This contains everything you need to run your app locally.

View your app in AI Studio: https://ai.studio/apps/drive/1AfT_Sqrp8gh-ynBiQpga6dH5FfK7Qu3l

## Run Locally

**Prerequisites:**  Node.js


1. Install dependencies:
   `npm install`
2. Set the `GEMINI_API_KEY` in [.env.local](.env.local) to your Gemini API key
3. Run the app:
   `npm run dev`


// END OF FILE: README.md
// ==========================================================================

// FILE: components/Blackboard.tsx
// --------------------------------------------------------------------------

// FILE: components/Blackboard.tsx
// --------------------------------------------------------------------------

import React, { useEffect, useRef, useState } from 'react';
import { Quiz, GeneratedDiagram } from '../types';

interface BlackboardProps {
  content: string;
  fullLesson: string;
  thoughts: string;
  isWriting: boolean;
  topic?: string;
  quiz?: Quiz | null;
  diagram?: GeneratedDiagram | null;
  // REMOVED: onOverflow prop is no longer needed
  onCloseQuiz?: () => void;
  onCloseDiagram?: () => void;
  onQuizComplete?: (result: any) => void;
}

const Blackboard: React.FC<BlackboardProps> = ({ 
  content, fullLesson, thoughts, isWriting, topic, quiz, diagram,
  onCloseQuiz, onCloseDiagram, onQuizComplete
}) => {
  const containerRef = useRef<HTMLDivElement>(null);
  const textRef = useRef<HTMLDivElement>(null);
  const thoughtRef = useRef<HTMLDivElement>(null);
  const lessonLogRef = useRef<HTMLDivElement>(null);
  const bottomRef = useRef<HTMLDivElement>(null); // New ref for auto-scrolling
  const [isSidebarCollapsed, setIsSidebarCollapsed] = useState(true);

  // Auto-scroll thoughts and lesson log
  useEffect(() => { if (thoughtRef.current) thoughtRef.current.scrollTop = thoughtRef.current.scrollHeight; }, [thoughts]);
  useEffect(() => { if (lessonLogRef.current) lessonLogRef.current.scrollTop = lessonLogRef.current.scrollHeight; }, [fullLesson]);

  // NEW: Auto-scroll the main blackboard text
  useEffect(() => {
    if (bottomRef.current && isWriting) {
      bottomRef.current.scrollIntoView({ behavior: 'smooth', block: 'end' });
    }
  }, [content, isWriting]);

  return (
    <div className="flex-1 w-full max-w-7xl mx-auto p-4 md:p-8 min-h-0 relative flex gap-4 overflow-hidden">
      
      {/* Sidebar Toggle */}
      <button onClick={() => setIsSidebarCollapsed(!isSidebarCollapsed)} className="absolute left-6 top-1/2 -translate-y-1/2 z-[60] w-8 h-32 bg-green-600/10 hover:bg-green-600/20 border border-green-600/30 backdrop-blur-md rounded-full flex items-center justify-center transition-all">
        <div className={`transition-transform duration-500 ${isSidebarCollapsed ? '' : 'rotate-180'}`}>
          <svg className="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth={3} d="M13 5l7 7-7 7M5 5l7 7-7 7" /></svg>
        </div>
      </button>

      {/* Sidebars (Thoughts & Logs) */}
      <div className={`shrink-0 flex flex-col h-full gap-4 transition-all duration-500 ${isSidebarCollapsed ? 'w-0 opacity-0 -ml-4' : 'w-80 opacity-100'}`}>
        <div className="flex-1 flex flex-col bg-green-500/5 rounded-xl border-2 border-green-500/10 p-4 backdrop-blur-sm overflow-hidden">
          <span className="marker-font text-[10px] text-white/40 uppercase tracking-widest mb-2 border-b border-white/5 pb-2">Internal Thoughts</span>
          <div ref={thoughtRef} className="flex-1 overflow-y-auto scrollbar-hide text-[11px] text-yellow-100/30 handwritten italic space-y-2">{thoughts || "Planning instruction..."}</div>
        </div>
        <div className="flex-1 flex flex-col bg-white/5 rounded-xl border-2 border-white/5 p-4 backdrop-blur-sm overflow-hidden">
          <span className="marker-font text-[10px] text-green-400 uppercase tracking-widest mb-2 border-b border-white/10 pb-2">Transcript Log</span>
          <div ref={lessonLogRef} className="flex-1 overflow-y-auto scrollbar-hide text-[13px] text-white/40 handwritten space-y-2">{fullLesson || "Listening..."}</div>
        </div>
      </div>

      {/* Main Blackboard Area */}
      <div className="chalk-board flex-1 rounded-xl border-8 border-[#3d2b1f] relative overflow-hidden flex flex-col p-8 bg-[#1e3a2f] shadow-2xl">
        <div className="absolute top-4 left-0 right-0 flex justify-center opacity-10 pointer-events-none marker-font text-white text-2xl uppercase">{topic || "Classroom"}</div>
        
        {/* Diagram Overlay */}
        {diagram && !quiz && (
          <div className="absolute right-8 top-12 bottom-20 w-[42%] z-30 animate-fade-in flex flex-col">
            <div className="flex justify-between items-center mb-2 px-2 bg-black/20 rounded-t-lg">
                <span className="marker-font text-[10px] text-yellow-400/80 uppercase">{diagram.topic}</span>
                <button onClick={onCloseDiagram} className="text-white/40 hover:text-white">√ó</button>
            </div>
            <div className="flex-1 relative bg-white/90 rounded-b-lg overflow-hidden flex items-center justify-center p-2">
                <img 
                    src={diagram.url} 
                    className="max-w-full max-h-full object-contain mix-blend-multiply brightness-110 contrast-125" 
                    alt={diagram.topic} 
                />
            </div>
          </div>
        )}

        {/* Quiz Overlay */}
        {quiz && (
          <div className="absolute inset-0 z-40 bg-[#1e3a2f]/98 backdrop-blur-md p-8 overflow-y-auto flex flex-col items-center">
            <div className="w-full max-w-2xl text-center space-y-8">
              <h2 className="marker-font text-3xl text-yellow-400">{quiz.title}</h2>
              <div className="text-left space-y-8">
                {quiz.questions.map((q, i) => (
                  <div key={i} className="space-y-3">
                    <p className="handwritten text-2xl text-white">{i + 1}. {q.question}</p>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                      {q.options.map((opt, oi) => (
                        <button key={oi} className="text-left px-4 py-2 rounded-xl border border-white/10 bg-white/5 handwritten text-xl text-white/70 hover:bg-white/10 transition-all">{opt}</button>
                      ))}
                    </div>
                  </div>
                ))}
              </div>
              <button onClick={onCloseQuiz} className="w-full py-4 bg-yellow-400 text-black font-bold rounded-2xl marker-font">Resume Lesson</button>
            </div>
          </div>
        )}

        {/* Text Container - CHANGED: overflow-y-auto enables scrolling, scrollbar-hide hides the bar */}
        <div ref={containerRef} className={`flex-1 relative overflow-y-auto scrollbar-hide transition-opacity ${quiz ? 'opacity-0' : 'opacity-100'}`}>
          <div ref={textRef} className={`handwritten text-white leading-relaxed whitespace-pre-wrap transition-all pb-10 ${diagram ? 'pr-[45%] text-2xl md:text-3xl' : 'text-4xl md:text-5xl px-8'}`}>
            {content}
            {isWriting && <span className="inline-block w-2 h-10 bg-white/60 ml-1 animate-pulse" />}
            {/* Invisible anchor for scrolling */}
            <div ref={bottomRef} className="h-2 w-full" /> 
          </div>
        </div>
      </div>
    </div>
  );
};

export default Blackboard;

// END OF FILE: components/Blackboard.tsx
// ==========================================================================

// FILE: components/CertificateView.tsx
// --------------------------------------------------------------------------

// FILE: src/components/CertificateView.tsx
// --------------------------------------------------------------------------

import React, { useRef, useState } from 'react';
import { Award, Download, Share2 } from 'lucide-react';
import { toPng, toJpeg } from 'html-to-image';
import jsPDF from 'jspdf';

interface CertificateViewProps {
  topicTitle: string;
  courseTitle?: string;
  userName: string;
  completionDate: string;
}

const CertificateView: React.FC<CertificateViewProps> = ({
  topicTitle,
  userName,
  completionDate,
}) => {
  const certificateContentRef = useRef<HTMLDivElement>(null);
  const [isDownloading, setIsDownloading] = useState(false);

  const sanitizeFilename = (name: string) => name.replace(/[^a-z0-9_.-]/gi, '_').replace(/_{2,}/g, '_');

  const handleDownloadPNG = async () => {
    if (!certificateContentRef.current || isDownloading) return;
    setIsDownloading(true);
    
    try {
      const elementToCapture = certificateContentRef.current;
      const dataUrl = await toPng(elementToCapture, {
        quality: 1.0,
        pixelRatio: 3, 
        backgroundColor: '#000000',
      });

      const link = document.createElement('a');
      link.download = `Seeker_Certificate_${sanitizeFilename(topicTitle)}.png`;
      link.href = dataUrl;
      link.click();
    } catch (error) {
      console.error("PNG generation failed:", error);
    } finally {
      setIsDownloading(false);
    }
  };

  const handleDownloadPDF = async () => {
    if (!certificateContentRef.current || isDownloading) return;
    setIsDownloading(true);
    
    try {
      const elementToCapture = certificateContentRef.current;
      const dataUrl = await toJpeg(elementToCapture, {
        quality: 1.0,
        pixelRatio: 3,
        backgroundColor: '#000000',
      });

      const pdf = new jsPDF({
        orientation: 'landscape',
        unit: 'mm',
        format: 'a4',
      });

      const pdfWidth = pdf.internal.pageSize.getWidth();
      const pdfHeight = pdf.internal.pageSize.getHeight();
      
      pdf.addImage(dataUrl, 'JPEG', 0, 0, pdfWidth, pdfHeight);
      pdf.save(`Seeker_Certificate_${sanitizeFilename(topicTitle)}.pdf`);
    } catch (error) {
      console.error('PDF generation failed:', error);
    } finally {
      setIsDownloading(false);
    }
  };

  return (
    <div className="w-full animate-fade-in space-y-8">
      
      {/* CERTIFICATE DOCUMENT - Fixed Aspect Ratio */}
      <div className="relative overflow-hidden rounded-xl shadow-2xl max-w-4xl mx-auto">
        <div
          ref={certificateContentRef}
          className="relative text-center"
          style={{ 
            aspectRatio: '210/297', // A4 portrait ratio
            background: `
              radial-gradient(circle at 10% 20%, rgba(212, 175, 55, 0.03) 0%, transparent 40%),
              radial-gradient(circle at 90% 80%, rgba(212, 175, 55, 0.03) 0%, transparent 40%),
              linear-gradient(145deg, #000000 0%, #1a1a1a 50%, #000000 100%)
            `,
            border: '4px solid #d4af37',
            borderRadius: '0.75rem',
            boxShadow: `
              0 0 0 1px rgba(212, 175, 55, 0.2),
              0 20px 60px rgba(0, 0, 0, 0.8),
              inset 0 1px 0 rgba(212, 175, 55, 0.1)
            `,
            padding: '3rem 2rem'
          }}
        >
          {/* Gold Particles - More subtle */}
          <div className="absolute top-[10%] right-[15%] w-2 h-2 rotate-45 opacity-60" 
               style={{ background: '#d4af37' }} />
          <div className="absolute top-[15%] left-[18%] w-1.5 h-1.5 -rotate-45 opacity-50" 
               style={{ background: '#f4e5b1' }} />
          <div className="absolute bottom-[25%] right-[12%] w-1.5 h-1.5 rotate-12 opacity-55" 
               style={{ background: '#d4af37' }} />
          <div className="absolute bottom-[30%] left-[15%] w-2 h-2 rotate-90 opacity-45" 
               style={{ background: '#b8941f' }} />

          {/* Corner Ornaments */}
          <div className="absolute top-6 left-6 w-16 h-16 pointer-events-none">
            <div className="absolute top-0 left-0 w-full h-0.5" 
                 style={{ background: 'linear-gradient(to right, #d4af37 0%, transparent 100%)' }} />
            <div className="absolute top-0 left-0 w-0.5 h-full" 
                 style={{ background: 'linear-gradient(to bottom, #d4af37 0%, transparent 100%)' }} />
            <div className="absolute top-0 left-0 w-2 h-2 bg-[#d4af37] transform rotate-45" />
          </div>
          
          <div className="absolute top-6 right-6 w-16 h-16 pointer-events-none">
            <div className="absolute top-0 right-0 w-full h-0.5" 
                 style={{ background: 'linear-gradient(to left, #d4af37 0%, transparent 100%)' }} />
            <div className="absolute top-0 right-0 w-0.5 h-full" 
                 style={{ background: 'linear-gradient(to bottom, #d4af37 0%, transparent 100%)' }} />
            <div className="absolute top-0 right-0 w-2 h-2 bg-[#d4af37] transform rotate-45" />
          </div>
          
          <div className="absolute bottom-6 left-6 w-16 h-16 pointer-events-none">
            <div className="absolute bottom-0 left-0 w-full h-0.5" 
                 style={{ background: 'linear-gradient(to right, #d4af37 0%, transparent 100%)' }} />
            <div className="absolute bottom-0 left-0 w-0.5 h-full" 
                 style={{ background: 'linear-gradient(to top, #d4af37 0%, transparent 100%)' }} />
            <div className="absolute bottom-0 left-0 w-2 h-2 bg-[#d4af37] transform rotate-45" />
          </div>
          
          <div className="absolute bottom-6 right-6 w-16 h-16 pointer-events-none">
            <div className="absolute bottom-0 right-0 w-full h-0.5" 
                 style={{ background: 'linear-gradient(to left, #d4af37 0%, transparent 100%)' }} />
            <div className="absolute bottom-0 right-0 w-0.5 h-full" 
                 style={{ background: 'linear-gradient(to top, #d4af37 0%, transparent 100%)' }} />
            <div className="absolute bottom-0 right-0 w-2 h-2 bg-[#d4af37] transform rotate-45" />
          </div>

          {/* Main Content - Properly Spaced */}
          <div className="relative z-10 h-full flex flex-col justify-between">
            
            {/* HEADER - 15% height */}
            <div className="pt-2">
              <h1 
                className="text-3xl sm:text-4xl lg:text-5xl uppercase leading-none mb-3"
                style={{ 
                  fontFamily: "'Playfair Display', serif",
                  fontWeight: 600,
                  color: '#d4af37',
                  letterSpacing: '0.2em',
                  textShadow: `
                    0 0 20px rgba(212, 175, 55, 0.4),
                    0 0 40px rgba(212, 175, 55, 0.2),
                    2px 2px 4px rgba(0, 0, 0, 0.5)
                  `
                }}
              >
                CERTIFICATE
              </h1>
              <div className="w-2 h-2 bg-[#d4af37] rotate-45 mx-auto mb-2" />
              <p 
                className="text-sm sm:text-base lg:text-lg uppercase"
                style={{ 
                  fontFamily: "'Cinzel', serif",
                  fontWeight: 300,
                  color: 'rgba(212, 175, 55, 0.85)',
                  letterSpacing: '0.3em',
                  textShadow: '0 2px 8px rgba(0, 0, 0, 0.3)'
                }}
              >
                OF COMPLETION
              </p>
            </div>

            {/* BODY - 70% height */}
            <div className="flex-1 flex flex-col justify-center py-4">
              
              <p 
                className="text-xs sm:text-sm uppercase mb-6"
                style={{ 
                  color: 'rgba(255, 255, 255, 0.8)',
                  letterSpacing: '0.2em',
                  fontWeight: 300
                }}
              >
                THIS CERTIFICATE IS<br/>AWARDED TO
              </p>
              
              <h2 
                className="text-3xl sm:text-5xl lg:text-6xl mb-8 px-4"
                style={{ 
                  fontFamily: "'Great Vibes', cursive",
                  color: '#d4af37',
                  fontWeight: 400,
                  textShadow: `
                    0 0 15px rgba(212, 175, 55, 0.5),
                    0 0 30px rgba(212, 175, 55, 0.3),
                    2px 2px 6px rgba(0, 0, 0, 0.4)
                  `,
                  lineHeight: 1.2
                }}
              >
                {userName}
              </h2>

              <div className="max-w-xl mx-auto mb-6 px-6">
                <p 
                  className="text-xs sm:text-sm leading-relaxed"
                  style={{ 
                    fontFamily: "'Lato', sans-serif",
                    color: 'rgba(255, 255, 255, 0.65)',
                    fontWeight: 300,
                    lineHeight: 1.5
                  }}
                >
                  For successfully demonstrating mastery and exceptional achievement in the comprehensive study of
                </p>
              </div>
              
              <h3 
                className="text-lg sm:text-xl lg:text-2xl uppercase max-w-lg mx-auto leading-tight px-8 mb-8"
                style={{ 
                  color: '#ffffff',
                  fontWeight: 700,
                  letterSpacing: '0.08em',
                  textShadow: '0 2px 8px rgba(0, 0, 0, 0.5)',
                  lineHeight: 1.3
                }}
              >
                {topicTitle}
              </h3>

              {/* Gold Seal - Positioned in body */}
              <div className="mx-auto mb-4">
                <div className="relative w-16 h-16 sm:w-20 sm:h-20">
                  {/* Outer glow */}
                  <div className="absolute inset-0 rounded-full" 
                       style={{ 
                         background: 'radial-gradient(circle, rgba(212, 175, 55, 0.4) 0%, transparent 70%)',
                         filter: 'blur(8px)',
                         transform: 'scale(1.4)'
                       }} />
                  
                  {/* Outer ring */}
                  <div className="absolute inset-0 rounded-full border-[3px] z-10"
                       style={{ 
                         borderColor: '#d4af37',
                         background: `
                           radial-gradient(circle, #f4e5b1 0%, #d4af37 50%, #b8941f 100%)
                         `,
                         boxShadow: `
                           0 0 20px rgba(212, 175, 55, 0.6),
                           inset 0 2px 4px rgba(255, 255, 255, 0.3),
                           inset 0 -2px 4px rgba(0, 0, 0, 0.3)
                         `
                       }} />
                  
                  {/* Inner circle */}
                  <div className="absolute inset-2 rounded-full flex items-center justify-center z-20"
                       style={{ 
                         background: 'linear-gradient(135deg, #d4af37 0%, #b8941f 100%)',
                         boxShadow: 'inset 0 2px 4px rgba(0, 0, 0, 0.3)'
                       }}>
                    <Award className="w-6 h-6 sm:w-8 sm:h-8" style={{ color: '#1a1a1a' }} />
                  </div>
                </div>
              </div>
            </div>

            {/* FOOTER - 15% height */}
            <div className="pb-2">
              {/* Signatures */}
              <div className="flex justify-between items-end max-w-3xl mx-auto px-4 mb-6">
                
                <div className="text-left flex-1">
                  <div className="h-px w-24 sm:w-32 mb-2" 
                       style={{ background: 'linear-gradient(to right, #d4af37 0%, transparent 100%)' }} />
                </div>

                <div className="text-center flex-1 px-2">
                  <p className="text-[7px] sm:text-[8px] uppercase tracking-widest mb-0.5" 
                     style={{ color: 'rgba(255, 255, 255, 0.35)', fontWeight: 700 }}>
                    Date Issued
                  </p>
                  <p className="text-xs" style={{ color: '#d4af37' }}>
                    {completionDate}
                  </p>
                </div>

                <div className="text-right flex-1">
                  <div className="h-px w-24 sm:w-32 mb-2 ml-auto" 
                       style={{ background: 'linear-gradient(to left, #d4af37 0%, transparent 100%)' }} />
                </div>
              </div>

              {/* Watermark */}
              <div className="text-[6px] sm:text-[7px] uppercase tracking-[0.3em]" 
                   style={{ color: 'rgba(255, 255, 255, 0.08)' }}>
                Seeker ‚Ä¢ Est. MMXXVI
              </div>
            </div>

          </div>
        </div>
      </div>

      {/* Action Buttons */}
      <div className="flex flex-col sm:flex-row gap-4 justify-center">
        <button
          onClick={handleDownloadPNG}
          disabled={isDownloading}
          className="flex items-center justify-center gap-2 px-6 py-3 bg-gradient-to-r from-[#d4af37] to-[#f4e5b1] text-black rounded-xl font-black uppercase text-xs tracking-widest hover:shadow-[0_0_20px_rgba(212,175,55,0.5)] transition-all shadow-lg active:scale-95 disabled:opacity-50"
        >
          <Download size={16} />
          {isDownloading ? 'Processing...' : 'Download Image'}
        </button>
        
        <button
          onClick={handleDownloadPDF}
          disabled={isDownloading}
          className="flex items-center justify-center gap-2 px-6 py-3 bg-gray-900 text-[#d4af37] border border-[#d4af37] rounded-xl font-black uppercase text-xs tracking-widest hover:bg-black transition-all shadow-lg active:scale-95 disabled:opacity-50"
        >
          <Share2 size={16} />
          {isDownloading ? 'Processing...' : 'Download PDF'}
        </button>
      </div>
      
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Great+Vibes&family=Cinzel:wght@400;700&family=Lato:wght@300;400&display=swap');
        
        .marker-font { font-family: 'Permanent Marker', cursive; }
        .handwritten { font-family: 'Caveat', cursive; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
      `}</style>
    </div>
  );
};

export default CertificateView;

// END OF FILE: components/CertificateView.tsx

// END OF FILE: components/CertificateView.tsx
// ==========================================================================

// FILE: components/IntelligentMarkdown.tsx
// --------------------------------------------------------------------------

import React from 'react';
import ReactMarkdown from 'react-markdown';
import remarkGfm from 'remark-gfm';

interface IntelligentMarkdownProps {
  content: string;
}

const IntelligentMarkdown: React.FC<IntelligentMarkdownProps> = ({ content }) => {
  // Aggressively parse and convert pseudo-tables to real markdown tables
  // Aggressively parse and convert pseudo-tables to real markdown tables
  // Aggressively parse and convert pseudo-tables to real markdown tables
  const preprocessContent = (text: string): string => {
    let processed = text;
    
    // Convert LaTeX arrows to visual arrows
    processed = processed.replace(/\$\\rightarrow\$/g, '‚Üí');
    processed = processed.replace(/\$\\Rightarrow\$/g, '‚áí');
    processed = processed.replace(/\$\\leftarrow\$/g, '‚Üê');
    processed = processed.replace(/\$\\Leftarrow\$/g, '‚áê');
    processed = processed.replace(/\$\\leftrightarrow\$/g, '‚Üî');
    processed = processed.replace(/\$\\Leftrightarrow\$/g, '‚áî');
    
    // Also handle without dollar signs
    processed = processed.replace(/\\rightarrow/g, '‚Üí');
    processed = processed.replace(/\\Rightarrow/g, '‚áí');
    processed = processed.replace(/\\leftarrow/g, '‚Üê');
    processed = processed.replace(/\\Leftarrow/g, '‚áê');
    processed = processed.replace(/\\leftrightarrow/g, '‚Üî');
    processed = processed.replace(/\\Leftrightarrow/g, '‚áî');
    
    // Convert common LaTeX comparison operators
    processed = processed.replace(/\\succ/g, '‚âª');
    processed = processed.replace(/\\sim/g, '‚àº');
    processed = processed.replace(/\\succeq/g, '‚™∞');
    processed = processed.replace(/\\preceq/g, '‚™Ø');
    
    // Remove dollar signs from simple inline math (single letters/numbers)
    // This handles cases like $A$, $B$, $1$, etc.
    processed = processed.replace(/\$([A-Za-z0-9])\$/g, '$1');
    
    // Handle more complex inline expressions by removing $ but keeping content
    // This is a fallback for any remaining $ expressions
    processed = processed.replace(/\$([^\$]+)\$/g, '$1');
    
    const lines = processed.split('\n');
    const output: string[] = [];
    let inTable = false;
    
    for (let i = 0; i < lines.length; i++) {
      const line = lines[i].trim();
      
      // Detect lines with slashes and pipes like: / Concept / Scenario / Explanation / | --- |
      if (line.includes('/') && line.includes('|')) {
        // Split by either / or | and clean up
        const parts = line.split(/[\/\|]/)
          .map(p => p.trim())
          .filter(p => p && p !== '---' && p !== '----');
        
        if (parts.length >= 2) {
          if (!inTable) {
            // First row - create header
            output.push('| ' + parts.join(' | ') + ' |');
            // Add separator
            output.push('| ' + parts.map(() => '---').join(' | ') + ' |');
            inTable = true;
          } else {
            // Subsequent rows
            output.push('| ' + parts.join(' | ') + ' |');
          }
          continue;
        }
      } else if (inTable && !line) {
        // Empty line ends table
        inTable = false;
      }
      
      output.push(lines[i]);
    }
    
    return output.join('\n');
  };

  const components = {
    table: ({ node, ...props }: any) => (
      <div className="overflow-x-auto my-10 rounded-xl border-2 border-gray-400 shadow-2xl">
        <table className="min-w-full divide-y-2 divide-gray-400" {...props} />
      </div>
    ),
    thead: ({ node, ...props }: any) => (
      <thead className="bg-gradient-to-r from-purple-200 to-blue-200" {...props} />
    ),
    tbody: ({ node, ...props }: any) => (
      <tbody className="bg-white divide-y-2 divide-gray-300" {...props} />
    ),
    tr: ({ node, ...props }: any) => (
      <tr className="hover:bg-blue-50 transition-colors" {...props} />
    ),
    th: ({ node, ...props }: any) => (
      <th className="px-8 py-5 text-left text-lg font-black text-gray-900 uppercase tracking-wide border-r-2 border-gray-300 last:border-r-0" {...props} />
    ),
    td: ({ node, ...props }: any) => (
      <td className="px-8 py-5 text-lg text-gray-900 font-medium leading-relaxed border-r border-gray-200 last:border-r-0" {...props} />
    ),
    h1: ({ node, ...props }: any) => (
      <h1 className="text-6xl font-black text-gray-900 mt-12 mb-8 pb-4 border-b-4 border-purple-400" {...props} />
    ),
    h2: ({ node, ...props }: any) => (
      <h2 className="text-5xl font-black text-gray-900 mt-10 mb-6" {...props} />
    ),
    h3: ({ node, ...props }: any) => (
      <h3 className="text-4xl font-bold text-gray-900 mt-8 mb-5" {...props} />
    ),
    h4: ({ node, ...props }: any) => (
      <h4 className="text-3xl font-bold text-gray-800 mt-7 mb-4" {...props} />
    ),
    p: ({ node, ...props }: any) => (
      <p className="text-xl text-gray-800 leading-relaxed my-6 font-normal" {...props} />
    ),
    ul: ({ node, ...props }: any) => (
      <ul className="list-disc list-inside space-y-4 my-8 ml-8 text-xl" {...props} />
    ),
    ol: ({ node, ...props }: any) => (
      <ol className="list-decimal list-inside space-y-4 my-8 ml-8 text-xl" {...props} />
    ),
    li: ({ node, ...props }: any) => (
      <li className="text-gray-800 leading-relaxed ml-4 text-xl font-normal" {...props} />
    ),
    code: ({ node, inline, ...props }: any) => 
      inline ? (
        <code className="px-3 py-1 bg-purple-200 text-purple-900 rounded text-lg font-mono font-bold" {...props} />
      ) : (
        <code className="block p-8 bg-gray-900 text-green-400 rounded-xl text-lg font-mono overflow-x-auto my-8 leading-relaxed" {...props} />
      ),
    blockquote: ({ node, ...props }: any) => (
      <blockquote className="border-l-8 border-purple-600 pl-8 py-4 my-8 italic text-gray-800 bg-purple-100 rounded-r-lg text-xl" {...props} />
    ),
    a: ({ node, ...props }: any) => (
      <a className="text-purple-700 hover:text-purple-900 underline text-xl font-semibold" target="_blank" rel="noopener noreferrer" {...props} />
    ),
    hr: ({ node, ...props }: any) => (
      <hr className="my-12 border-t-4 border-gray-400" {...props} />
    ),
    strong: ({ node, ...props }: any) => (
      <strong className="font-black text-gray-900" {...props} />
    ),
    em: ({ node, ...props }: any) => (
      <em className="italic text-gray-800 font-medium" {...props} />
    ),
    img: ({ node, ...props }: any) => (
      <img className="max-w-full h-auto rounded-xl shadow-2xl my-8" {...props} />
    ),
  };

  const processedContent = preprocessContent(content);

  return (
    <div className="prose prose-2xl max-w-none">
      <ReactMarkdown 
        components={components}
        remarkPlugins={[remarkGfm]}
      >
        {processedContent}
      </ReactMarkdown>
    </div>
  );
};

export default IntelligentMarkdown;

// END OF FILE: components/IntelligentMarkdown.tsx
// ==========================================================================

// FILE: components/SlideCinema.tsx
// --------------------------------------------------------------------------

// FILE: components/SlideCinema.tsx
import React, { useRef, useState, useEffect } from 'react';

export const SlideCinema = ({ videoUrl, totalSlides }: { videoUrl: string, totalSlides: number }) => {
  const videoRef = useRef<HTMLVideoElement>(null);
  const [currentSlide, setCurrentSlide] = useState(1);
  const [isPlaying, setIsPlaying] = useState(false);

  const seekSlide = (index: number) => {
    if (videoRef.current) {
      videoRef.current.currentTime = (index - 1) * 30;
      setCurrentSlide(index);
    }
  };

  return (
    <div className="w-full bg-[#062012] rounded-3xl overflow-hidden shadow-2xl border-4 border-[#22c55e]/20">
      <div className="relative aspect-video bg-black">
        <video 
          ref={videoRef} 
          src={videoUrl} 
          className="w-full h-full"
          onTimeUpdate={() => {
            const slide = Math.floor(videoRef.current!.currentTime / 30) + 1;
            if (slide !== currentSlide) setCurrentSlide(slide);
          }}
        />
      </div>

      <div className="p-6 bg-black/40">
        <div className="flex items-center gap-6">
          <button 
            onClick={() => {
                if (videoRef.current?.paused) { videoRef.current.play(); setIsPlaying(true); }
                else { videoRef.current?.pause(); setIsPlaying(false); }
            }}
            className="text-[#22c55e] hover:scale-110 transition-transform"
          >
            {isPlaying ? '‚è∏' : '‚ñ∂Ô∏è'}
          </button>

          {/* Segmented Progress Bar */}
          <div className="flex-1 flex gap-1 h-2">
            {Array.from({ length: totalSlides }).map((_, i) => (
              <div 
                key={i}
                onClick={() => seekSlide(i + 1)}
                className={`flex-1 rounded-full cursor-pointer transition-all ${
                  i + 1 <= currentSlide ? 'bg-[#22c55e] shadow-[0_0_10px_#22c55e]' : 'bg-white/10'
                }`}
              />
            ))}
          </div>
          
          <div className="marker-font text-[#22c55e] text-sm whitespace-nowrap">
            Slide {currentSlide} / {totalSlides}
          </div>
        </div>
      </div>
    </div>
  );
};

// END OF FILE: components/SlideCinema.tsx
// ==========================================================================

// FILE: index.html
// --------------------------------------------------------------------------


<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Seeker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&family=Inter:wght@400;600&family=Permanent+Marker&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background-color: #1a1a1a;
      font-family: 'Inter', sans-serif;
    }
    .chalk-board {
      background: linear-gradient(135deg, #1e3a2f 0%, #142d23 100%);
      box-shadow: inset 0 0 100px rgba(0,0,0,0.5);
      position: relative;
    }
    .chalk-board::after {
      content: "";
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background-image: url('https://www.transparenttextures.com/patterns/black-paper.png');
      opacity: 0.2;
      pointer-events: none;
    }
    .handwritten {
      font-family: 'Caveat', cursive;
    }
    .marker-font {
      font-family: 'Permanent Marker', cursive;
    }
    .scrollbar-hide::-webkit-scrollbar {
      display: none;
    }
    .scrollbar-hide {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in {
      animation: fadeIn 0.4s ease-out forwards;
    }
    @keyframes typing {
      from { width: 0 }
      to { width: 100% }
    }
    .writing-animation {
      overflow: hidden;
      white-space: pre-wrap;
      animation: typing 0.5s steps(30, end);
    }
  </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.3.1",
    "react/": "https://esm.sh/react@18.3.1/",
    "react-dom": "https://esm.sh/react-dom@18.3.1",
    "react-dom/client": "https://esm.sh/react-dom@18.3.1/client",
    "react-dom/": "https://esm.sh/react-dom@18.3.1/",
    "react/jsx-runtime": "https://esm.sh/react@18.3.1/jsx-runtime",
    "@google/genai": "https://esm.sh/@google/genai@1.34.0"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body>
  <div id="root"></div>
<script type="module" src="/index.tsx"></script>
</body>
</html>


// END OF FILE: index.html
// ==========================================================================

// FILE: index.tsx
// --------------------------------------------------------------------------

import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App';
import { ClerkProvider } from '@clerk/clerk-react';
import { BrowserRouter } from 'react-router-dom';

const PUBLISHABLE_KEY = import.meta.env.VITE_CLERK_PUBLISHABLE_KEY;

const root = ReactDOM.createRoot(document.getElementById('root')!);
root.render(
  <React.StrictMode>
    <ClerkProvider publishableKey={PUBLISHABLE_KEY}>
      <BrowserRouter>
        <App />
      </BrowserRouter>
    </ClerkProvider>
  </React.StrictMode>
);

// END OF FILE: index.tsx
// ==========================================================================

// FILE: metadata.json
// --------------------------------------------------------------------------

{
  "name": "Seeker",
  "description": "An interactive educational app where an AI teacher explains topics on a virtual blackboard using Gemini's Live API for real-time voice, vision, and visual animation.",
  "requestFramePermissions": [
    "microphone",
    "camera"
  ]
}

// END OF FILE: metadata.json
// ==========================================================================

// FILE: package.json
// --------------------------------------------------------------------------

{
  "name": "seeker",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "@clerk/clerk-react": "^5.59.2",
    "@google/genai": "^1.34.0",
    "@supabase/supabase-js": "^2.89.0",
    "dotenv": "^17.2.3",
    "html-to-image": "^1.11.13",
    "jspdf": "^4.1.0",
    "lucide-react": "^0.562.0",
    "react": "18.3.1",
    "react-dom": "18.3.1",
    "react-markdown": "^10.1.0",
    "react-router-dom": "^7.11.0",
    "remark-gfm": "^4.0.1"
  },
  "devDependencies": {
    "@types/node": "^22.14.0",
    "@vitejs/plugin-react": "^5.0.0",
    "typescript": "~5.8.2",
    "vite": "^6.2.0"
  }
}


// END OF FILE: package.json
// ==========================================================================

// FILE: pages/ArchivePage.tsx
// --------------------------------------------------------------------------

import React, { useEffect, useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { useUser } from '@clerk/clerk-react';
import { supabase } from '../src/lib/supabase';

const ArchivePage: React.FC = () => {
  const { user } = useUser();
  const navigate = useNavigate();
  const [lessons, setLessons] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    // Enable scrolling and set background for this page
    document.body.style.overflow = 'auto';
    document.documentElement.style.overflow = 'auto';
    document.body.style.height = 'auto';
    document.documentElement.style.height = 'auto';
    document.body.style.backgroundColor = '#f4f1ea';
    document.documentElement.style.backgroundColor = '#f4f1ea';

    return () => {
      // Reset on cleanup
      document.body.style.overflow = '';
      document.documentElement.style.overflow = '';
      document.body.style.backgroundColor = '';
      document.documentElement.style.backgroundColor = '';
    };
  }, []);

  useEffect(() => {
    const fetchLessons = async () => {
      if (!user) return;
      try {
        const { data, error } = await supabase
          .from('lessons')
          .select('*')
          .eq('student_id', user.id)
          .order('created_at', { ascending: false });
        if (error) throw error;
        setLessons(data || []);
      } catch (err) {
        console.error("Error fetching library:", err);
      } finally {
        setLoading(false);
      }
    };
    fetchLessons();
  }, [user]);

  if (loading) {
    return (
      <div className="h-screen bg-[#1a1a1a] flex items-center justify-center">
        <div className="w-12 h-12 border-4 border-green-500 border-t-transparent rounded-full animate-spin" />
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-[#f4f1ea] p-6 md:p-16 lg:p-24 font-sans selection:bg-green-200" style={{ minHeight: '100%', height: 'auto' }}>
      <header className="max-w-7xl mx-auto mb-16 flex flex-col md:flex-row justify-between items-start md:items-end gap-6">
        <div className="animate-fade-in">
          <h1 className="marker-font text-6xl md:text-8xl text-gray-800 uppercase tracking-tighter leading-none">My Archive</h1>
          <p className="handwritten text-xl md:text-3xl text-gray-400 mt-4 max-w-xl italic">
            "Education is not the filling of a pail, but the lighting of a fire."
          </p>
        </div>
        <button
          onClick={() => navigate('/')}
          className="w-full md:w-auto px-10 py-4 bg-gray-900 text-white rounded-2xl marker-font text-xl uppercase tracking-widest active:scale-95 transition-all shadow-2xl"
        >
          New Lesson
        </button>
      </header>

      <div className="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-12 gap-y-20 pb-24">
        {lessons.length === 0 ? (
          <div className="col-span-full py-48 text-center border-4 border-dashed border-gray-200 rounded-3xl">
            <h2 className="marker-font text-5xl text-gray-300">Shelf Empty</h2>
          </div>
        ) : (
          lessons.map((lesson) => (
            <div
              key={lesson.lesson_id}
              onClick={() => navigate(`/notes/${lesson.lesson_id}`)}
              className="notebook-wrapper group cursor-pointer"
              style={{ WebkitTapHighlightColor: 'transparent' }}
            >
              {/* NOTEBOOK CONTAINER */}
              <div className="notebook-cover relative w-full aspect-[3/4.2] bg-white rounded-r-2xl shadow-[0_15px_35px_rgba(0,0,0,0.15)] flex flex-col overflow-hidden border-l-[15px] border-black/5 transition-all duration-500 ease-[cubic-bezier(0.34,1.56,0.64,1)]">

                {/* Visual Header */}
                <div className="h-[45%] w-full bg-gray-100 relative overflow-hidden">
                  {lesson.banner_image ? (
                    <img
                      src={lesson.banner_image}
                      className="cover-image w-full h-full object-cover grayscale opacity-60 transition-all duration-700 scale-110"
                      alt="Cover"
                    />
                  ) : (
                    <div className="w-full h-full bg-green-900/10 flex items-center justify-center">
                      <span className="marker-font text-green-700/10 text-9xl">S.A</span>
                    </div>
                  )}
                  <div className="absolute inset-0 bg-black/5 group-hover:bg-transparent group-active:bg-transparent transition-colors" />
                </div>

                {/* Cover Details */}
                <div className="flex-1 p-6 md:p-8 flex flex-col justify-between bg-white relative">
                  <div>
                    <div className="flex justify-between items-center mb-4">
                      <span className="text-[10px] font-black uppercase tracking-[0.4em] text-gray-400">
                        Vol. {new Date(lesson.created_at).toLocaleDateString()}
                      </span>
                      <div className="dot-indicator w-2 h-2 rounded-full bg-green-500 opacity-0 transition-opacity" />
                    </div>
                    <h2 className="title-text marker-font text-3xl md:text-4xl text-gray-800 leading-[0.9] transition-colors uppercase">
                      {lesson.title}
                    </h2>
                  </div>

                  <div className="border-t-2 border-gray-50 pt-6">
                    <p className="handwritten text-lg md:text-xl text-gray-400 line-clamp-3 leading-tight italic">
                      {lesson.lesson_summary || "Lesson archive ready."}
                    </p>
                  </div>
                </div>

                {/* Binding Shadows */}
                <div className="absolute left-0 top-0 bottom-0 w-4 bg-gradient-to-r from-black/10 to-transparent pointer-events-none" />
              </div>
            </div>
          ))
        )}
      </div>

      <style>{`
        .notebook-wrapper {
          perspective: 1500px;
          user-select: none;
          -webkit-user-select: none;
          touch-action: pan-y pinch-zoom;
        }

        .notebook-cover {
          transform-origin: left center;
          will-change: transform, box-shadow;
        }

        /* Unified Desktop Hover & Mobile Touch Trigger */
        .notebook-wrapper:hover .notebook-cover,
        .notebook-wrapper:active .notebook-cover {
           transform: rotateY(-22deg) translateX(10px) scale(1.04);
           box-shadow: -25px 45px 85px -15px rgba(0,0,0,0.35);
           border-left-width: 18px;
        }

        .notebook-wrapper:hover .cover-image,
        .notebook-wrapper:active .cover-image {
           filter: grayscale(0);
           opacity: 1;
           transform: scale(1);
        }

        .notebook-wrapper:hover .title-text,
        .notebook-wrapper:active .title-text {
           color: #15803d; /* green-700 */
        }

        .notebook-wrapper:hover .dot-indicator,
        .notebook-wrapper:active .dot-indicator {
           opacity: 1;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.6s ease-out forwards; }
      `}</style>
    </div>
  );
};

export default ArchivePage;

// END OF FILE: pages/ArchivePage.tsx
// ==========================================================================

// FILE: pages/CourseDetailPage.tsx
// --------------------------------------------------------------------------

import React, { useEffect, useState } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { supabase } from '../src/lib/supabase';
import { GoogleGenAI, ThinkingLevel } from '@google/genai';

const TEXT_MODEL = "gemini-3-pro-preview"; // Latest Gemini 3 Pro
const IMAGE_MODEL = "gemini-3-pro-image-preview"; // Nano Banana Pro

const CourseDetailPage: React.FC = () => {
    const { courseId } = useParams();
    const navigate = useNavigate();

    const [course, setCourse] = useState<any>(null);
    const [modules, setModules] = useState<any[]>([]);
    const [isGenerating, setIsGenerating] = useState(false);

    useEffect(() => {
        fetchCourseAndModules();
    }, [courseId]);

    const fetchCourseAndModules = async () => {
        const { data: courseData } = await supabase.from('courses').select('*').eq('id', courseId).single();
        setCourse(courseData);

        const { data: moduleData } = await supabase
            .from('modules')
            .select(`*, lesson_plans (*)`)
            .eq('course_id', courseId)
            .order('order_index', { ascending: true });

        if (moduleData && moduleData.length > 0) {
            const sortedModules = moduleData.map(m => ({
                ...m,
                lesson_plans: m.lesson_plans.sort((a: any, b: any) => a.order_index - b.order_index)
            }));
            setModules(sortedModules);
        } else if (courseData) {
            // No curriculum found - trigger Gemini 3 Reasoning
            generateCurriculum(courseData);
        }
    };

    const generateCurriculum = async (courseInfo: any) => {
        setIsGenerating(true);
        try {
            const ai = new GoogleGenAI({ apiKey: process.env.GEMINI_API_KEY || '' });

            // DOCS COMPLIANT: Initializing Gemini 3 Pro with "High" Thinking Level for complex reasoning
            const result = await ai.models.generateContent({
                model: TEXT_MODEL,
                contents: [{
                    role: "user",
                    parts: [{
                        text: `As a Master Curriculum Architect, design a progressive learning path for: "${courseInfo.title}".

        Description: ${courseInfo.description}

        Apply the "Building Block Approach":

        1. Meso Level: 4 thematic Modules.

        2. Micro Level: 3 sequential Lesson Plans per module.

        Return ONLY JSON:

        {"modules": [{"title": "Module Title", "description": "", "lessons": [{"title": "Lesson Title", "objectives": ["obj1"], "preview": ""}]}]}`
                    }]
                }],
                config: {
                    thinkingConfig: {
                        thinkingLevel: ThinkingLevel.HIGH // DOCS: High depth for curriculum logic
                    }
                }
            });

            const data = JSON.parse(result.text.replace(/```json|```/g, '').trim());

            // 1. Transactional save to Supabase
            for (let i = 0; i < data.modules.length; i++) {
                const m = data.modules[i];
                const { data: newMod } = await supabase
                    .from('modules')
                    .insert({ course_id: courseId, title: m.title, description: m.description, order_index: i })
                    .select().single();

                const lessonsToInsert = m.lessons.map((l: any, idx: number) => ({
                    module_id: newMod.id,
                    title: l.title,
                    learning_objectives: l.objectives,
                    content_preview: l.preview,
                    order_index: idx,
                    // Unlock only the first lesson of the whole course
                    status: (i === 0 && idx === 0) ? 'ready' : 'locked'
                }));

                await supabase.from('lesson_plans').insert(lessonsToInsert);
            }

            fetchCourseAndModules();
        } catch (e) {
            console.error("Gemini 3 Logic Failure:", e);
        } finally {
            setIsGenerating(false);
        }
    };

    const allLessons = modules.flatMap(m => m.lesson_plans || []);
    const completedLessons = allLessons.filter(l => l.status === 'completed').length;
    const progressPercent = allLessons.length > 0 ? Math.round((completedLessons / allLessons.length) * 100) : 0;

    if (isGenerating) return (
        <div className="h-screen bg-[#1e3a2f] flex flex-col items-center justify-center p-10">
            <div className="w-24 h-24 border-8 border-yellow-400 border-t-transparent rounded-full animate-spin mb-8 shadow-2xl" />
            <h1 className="marker-font text-5xl text-yellow-400 uppercase animate-pulse">Consulting the Grand Architect...</h1>
            <p className="handwritten text-2xl text-white/40 mt-4 italic">Gemini 3 is deep-thinking your path to mastery.</p>
        </div>
    );

    return (
        <div className="min-h-screen bg-[#f4f1ea] p-8 md:p-20 text-gray-900 overflow-y-auto">
            <header className="max-w-6xl mx-auto mb-16 flex justify-between items-end gap-6">
                <div className="flex-1">
                    <button onClick={() => navigate('/courses')} className="text-gray-400 hover:text-black mb-8 flex items-center gap-2">
                        <span className="material-symbols-outlined">arrow_back</span> Library
                    </button>
                    <h1 className="marker-font text-6xl md:text-8xl uppercase tracking-tighter text-gray-800 leading-[0.8] mb-6">{course?.title}</h1>
                    <p className="handwritten text-3xl text-gray-400 italic max-w-4xl">{course?.description}</p>
                </div>
                <div className="text-right shrink-0">
                    <div className="text-8xl marker-font text-green-600">{progressPercent}%</div>
                    <div className="text-[10px] font-black uppercase tracking-widest text-gray-400">Mastery Level</div>
                </div>
            </header>

            <div className="max-w-6xl mx-auto space-y-24">
                {modules.map((module, mIdx) => {
                    const isModuleAccessible = module.lesson_plans?.some((l: any) => l.status !== 'locked');

                    return (
                        <section key={module.id} className="relative">
                            <div className="absolute left-10 top-24 bottom-[-6rem] w-1 bg-gray-200">
                                <div
                                    className="w-full bg-green-500 transition-all duration-1000"
                                    style={{ height: isModuleAccessible ? '100%' : '0%' }}
                                />
                            </div>

                            <div className="flex items-start gap-8 mb-12 relative z-10">
                                <div className={`w-20 h-20 rounded-2xl flex items-center justify-center marker-font text-4xl shadow-xl transition-colors duration-700
                                    ${isModuleAccessible ? 'bg-gray-900 text-yellow-400' : 'bg-gray-200 text-gray-400'}`}>
                                    {mIdx + 1}
                                </div>
                                <div className="pt-2">
                                    <h2 className="marker-font text-4xl uppercase text-gray-700 leading-none">{module.title}</h2>
                                    <p className="handwritten text-xl text-gray-400 mt-1 italic">{module.description}</p>
                                </div>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-3 gap-8 ml-0 md:ml-28">
                                {module.lesson_plans?.map((lesson: any, lIdx: number) => {
                                    const isLocked = lesson.status === 'locked';
                                    const isDone = lesson.status === 'completed';

                                    return (
                                        <div
                                            key={lesson.id}
                                            onClick={() => !isLocked && navigate(`/lesson/${lesson.id}`)}
                                            className={`group relative p-8 rounded-[3rem] shadow-xl border-b-8 transition-all duration-500
                                                ${isLocked ? 'bg-gray-50 border-gray-200 grayscale cursor-not-allowed opacity-60' : 'bg-white border-green-500 cursor-pointer hover:-translate-y-2 shadow-green-500/5'}`}
                                        >
                                            <div className="flex justify-between items-start mb-6">
                                                <span className="text-[10px] font-black uppercase text-gray-300 tracking-widest">Block {mIdx + 1}.{lIdx + 1}</span>
                                                <span className={`material-symbols-outlined ${isLocked ? 'text-gray-300' : isDone ? 'text-green-500' : 'text-yellow-500 animate-pulse'}`}>
                                                    {isLocked ? 'lock' : isDone ? 'verified' : 'play_circle'}
                                                </span>
                                            </div>

                                            <h4 className={`marker-font text-2xl uppercase leading-tight mb-4 ${isLocked ? 'text-gray-300' : 'text-gray-800'}`}>
                                                {lesson.title}
                                            </h4>

                                            <div className="space-y-2 opacity-60">
                                                {lesson.learning_objectives?.slice(0, 2).map((obj: string, i: number) => (
                                                    <div key={i} className="handwritten text-sm text-gray-500">‚Ä¢ {obj}</div>
                                                ))}
                                            </div>

                                            {isLocked && (
                                                <div className="absolute inset-0 flex items-center justify-center bg-white/40 backdrop-blur-[1px] rounded-[3rem]">
                                                    <span className="material-symbols-outlined text-4xl text-gray-200">lock_outline</span>
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        </section>
                    );
                })}
            </div>
            <style>{` .marker-font { font-family: 'Permanent Marker', cursive; } .handwritten { font-family: 'Caveat', cursive; } `}</style>
        </div>
    );
};

export default CourseDetailPage;

// END OF FILE: pages/CourseDetailPage.tsx
// ==========================================================================

// FILE: pages/CoursesPage.tsx
// --------------------------------------------------------------------------

import React, { useEffect, useState } from 'react';
import { useUser } from '@clerk/clerk-react';
import { supabase } from '../src/lib/supabase';
import { useNavigate } from 'react-router-dom';
import { GoogleGenAI } from '@google/genai';

const IMAGE_MODEL_NAME = 'gemini-3-pro-image-preview';
const TEXT_MODEL_NAME = 'gemini-3-flash-preview';

const CoursesPage: React.FC = () => {
  const { user } = useUser();
  const navigate = useNavigate();
  const [courses, setCourses] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);

  // Creation State
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [isCreating, setIsCreating] = useState(false);
  const [topicInput, setTopicInput] = useState('');
  const [selectedFiles, setSelectedFiles] = useState<File[]>([]); // Array for multiple PDFs

  useEffect(() => {
    fetchCourses();
  }, [user]);

  const fetchCourses = async () => {
    if (!user) return;
    const { data, error } = await supabase
      .from('courses')
      .select(`*, modules (id, lesson_plans (id, status))`)
      .eq('student_id', user.id)
      .order('created_at', { ascending: false });

    if (!error) setCourses(data || []);
    setLoading(false);
  };

  const calculateProgress = (course: any) => {
    const allLessons = course.modules?.flatMap((m: any) => m.lesson_plans || []) || [];
    if (allLessons.length === 0) return 0;
    const completedCount = allLessons.filter((l: any) => l.status === 'completed').length;
    return Math.round((completedCount / allLessons.length) * 100);
  };

  const fileToBase64 = (file: File): Promise<string> => {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => resolve((reader.result as string).split(',')[1]);
      reader.onerror = error => reject(error);
    });
  };

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = Array.from(e.target.files || []);
    // Strict PDF validation
    const pdfFiles = files.filter(file => file.type === 'application/pdf');

    if (pdfFiles.length !== files.length) {
      alert("Only PDF documents are allowed. Non-PDF files have been removed.");
    }

    setSelectedFiles(pdfFiles);
  };

  const handleCreateCourse = async () => {
    if (!topicInput.trim() && selectedFiles.length === 0) return;
    setIsCreating(true);
    setIsModalOpen(false);

    try {
      const ai = new GoogleGenAI({ apiKey: process.env.API_KEY || '' });

      const prompt = `As a Master Curriculum Architect, design a progressive learning path based on the provided documents. 
      Topic Context: ${topicInput}. 
      
      Rules:
      1. Analyze ALL provided documents to create a cohesive structure.
      2. Return ONLY valid JSON:
      {
        "title": "Course Title",
        "description": "Engaging summary",
        "difficulty": "Beginner/Intermediate/Advanced",
        "modules": [
          {
            "title": "Module Title",
            "description": "Module summary",
            "lessons": [
              { "title": "Lesson Title", "objectives": ["obj1", "obj2"], "preview": "Short teaser" }
            ]
          }
        ]
      }`;

      // Process multiple PDFs into parts
      const fileParts = await Promise.all(
        selectedFiles.map(async (file) => ({
          inlineData: {
            mimeType: "application/pdf",
            data: await fileToBase64(file)
          }
        }))
      );

      const contents = [
        ...fileParts,
        { text: prompt }
      ];

      const result = await ai.models.generateContent({
        model: TEXT_MODEL_NAME,
        contents
      });
      const responseText = result.text.replace(/```json|```/g, '').trim();
      const courseData = JSON.parse(responseText);

      // Generate Card Banner
      const bannerResult = await ai.models.generateContent({
        model: IMAGE_MODEL_NAME,
        contents: `Educational cover for ${courseData.title}, clean academic style, white background.`
      });
      const bannerPart = bannerResult.candidates?.[0].content.parts.find(p => p.inlineData);
      const bannerUrl = bannerPart?.inlineData ? `data:${bannerPart.inlineData.mimeType};base64,${bannerPart.inlineData.data}` : '';

      // Save Course
      const { data: newCourse } = await supabase.from('courses').insert({
        student_id: user?.id,
        title: courseData.title,
        description: courseData.description,
        difficulty: courseData.difficulty,
        banner_url: bannerUrl,
        status: 'ready'
      }).select().single();

      // Save Modules & Lessons
      for (let i = 0; i < courseData.modules.length; i++) {
        const m = courseData.modules[i];
        const { data: mod } = await supabase.from('modules').insert({
          course_id: newCourse.id,
          title: m.title,
          description: m.description,
          order_index: i
        }).select().single();

        const lessons = m.lessons.map((l: any, idx: number) => ({
          module_id: mod.id,
          title: l.title,
          learning_objectives: l.objectives,
          content_preview: l.preview,
          order_index: idx,
          status: (i === 0 && idx === 0) ? 'ready' : 'locked'
        }));
        await supabase.from('lesson_plans').insert(lessons);
      }

      await fetchCourses();
      navigate(`/course/${newCourse.id}`);

    } catch (err) {
      console.error("Creation failed:", err);
      alert("Failed to generate course. Please ensure PDFs are not password protected.");
    } finally {
      setIsCreating(false);
      setTopicInput('');
      setSelectedFiles([]);
    }
  };

  if (loading || isCreating) return (
    <div className="h-screen bg-[#022c22] flex flex-col items-center justify-center">
      <div className="w-16 h-16 border-4 border-yellow-400 border-t-transparent rounded-full animate-spin mb-4 shadow-[0_0_30px_rgba(250,204,20,0.2)]" />
      <span className="marker-font text-yellow-400 text-xl animate-pulse">
        {isCreating ? `Architecting ${selectedFiles.length > 0 ? selectedFiles.length : ''} Knowledge Sources...` : 'Opening Library...'}
      </span>
    </div>
  );

  return (
    <div className="min-h-screen bg-[#022c22] p-8 md:p-20 relative overflow-x-hidden">
      <header className="max-w-7xl mx-auto mb-16 flex flex-col md:flex-row justify-between items-start md:items-end gap-6 relative z-10">
        <div className="animate-fade-in">
          <h1 className="marker-font text-6xl md:text-8xl text-yellow-400 uppercase tracking-tighter leading-none">The Library</h1>
          <p className="handwritten text-2xl md:text-3xl text-white/40 mt-2 italic">Select a volume to begin your structured journey.</p>
        </div>
        <div className="flex gap-4">
          <button onClick={() => setIsModalOpen(true)} className="bg-white/10 text-white border border-white/20 px-10 py-4 rounded-2xl font-black uppercase tracking-widest hover:bg-white/20 transition-all flex items-center gap-2">
            <span className="material-symbols-outlined">add_circle</span> Create Course
          </button>
          <button onClick={() => navigate('/')} className="bg-yellow-400 text-[#022c22] px-10 py-4 rounded-2xl font-black uppercase tracking-widest hover:scale-105 transition-all">Quick Lesson</button>
        </div>
      </header>

      {/* Course Grid */}
      <div className="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-12 relative z-10">
        {courses.map((course) => (
          <div key={course.id} onClick={() => navigate(`/course/${course.id}`)} className="group cursor-pointer bg-white/5 border-2 border-white/5 rounded-[3rem] overflow-hidden hover:border-yellow-400/40 transition-all shadow-xl">
            <div className="h-56 bg-gray-900 relative overflow-hidden">
              <img src={course.banner_url} className="w-full h-full object-cover opacity-40 group-hover:opacity-80 transition-all" alt={course.title} />
              <div className="absolute top-6 right-6 bg-black/60 backdrop-blur-md px-4 py-2 rounded-2xl border border-white/10">
                <span className="text-xl marker-font text-yellow-400">{calculateProgress(course)}%</span>
              </div>
            </div>
            <div className="p-8">
              <h3 className="text-3xl font-serif font-black text-white uppercase leading-tight mb-4">{course.title}</h3>
              <p className="text-white/40 font-handwriting text-xl mb-8 italic line-clamp-2">{course.description}</p>
              <div className="flex justify-between items-center pt-6 border-t border-white/5">
                <span className="text-xs font-bold text-white/60 uppercase">{course.difficulty}</span>
                <span className="material-symbols-outlined text-white/20">auto_stories</span>
              </div>
            </div>
          </div>
        ))}
      </div>

      {/* CREATE COURSE MODAL */}
      {isModalOpen && (
        <div className="fixed inset-0 z-[100] flex items-center justify-center p-6 bg-black/90 backdrop-blur-xl">
          <div className="bg-[#1e1e1e] border border-white/10 p-12 rounded-[3.5rem] w-full max-w-2xl shadow-2xl">
            <h2 className="marker-font text-5xl text-yellow-400 mb-2 uppercase tracking-tighter">Architect Course</h2>
            <p className="text-white/40 text-xl font-handwriting italic mb-8">"Upload your PDF documents, and I shall synthesize them into a curriculum."</p>

            <div className="space-y-6">
              <input
                type="text"
                placeholder="Course Topic / Goal (Optional)"
                value={topicInput}
                onChange={(e) => setTopicInput(e.target.value)}
                className="w-full bg-white/5 border border-white/10 rounded-2xl px-6 py-4 text-white text-xl outline-none focus:ring-2 focus:ring-yellow-400"
              />

              <div className="relative group">
                <input
                  type="file"
                  accept=".pdf,application/pdf" // Restrict to PDF
                  multiple // Allow multiple
                  onChange={handleFileChange}
                  className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"
                />
                <div className={`w-full border-2 border-dashed rounded-2xl py-10 flex flex-col items-center justify-center transition-all ${selectedFiles.length > 0 ? 'border-green-500 bg-green-500/5' : 'border-white/10 bg-white/5 group-hover:border-yellow-400/50'}`}>
                  <span className={`material-symbols-outlined text-5xl mb-3 ${selectedFiles.length > 0 ? 'text-green-400' : 'text-white/20'}`}>
                    {selectedFiles.length > 0 ? 'library_books' : 'upload_file'}
                  </span>
                  <p className="text-sm font-black uppercase tracking-[0.2em] text-white/40 text-center px-4">
                    {selectedFiles.length > 0
                      ? `${selectedFiles.length} PDF Documents Prepared`
                      : 'Upload PDF Sources (Multiple Allowed)'}
                  </p>
                  {selectedFiles.length > 0 && (
                    <div className="mt-4 flex flex-wrap justify-center gap-2 px-6">
                      {selectedFiles.map((f, i) => (
                        <span key={i} className="text-[9px] bg-white/5 px-2 py-1 rounded text-white/30 truncate max-w-[120px]">{f.name}</span>
                      ))}
                    </div>
                  )}
                </div>
              </div>

              <div className="flex gap-4 pt-4">
                <button onClick={() => { setIsModalOpen(false); setSelectedFiles([]); }} className="flex-1 py-4 text-white/40 font-bold uppercase text-[10px] tracking-widest">Cancel</button>
                <button
                  onClick={handleCreateCourse}
                  className="flex-1 py-4 bg-yellow-400 text-black rounded-xl font-black uppercase text-sm tracking-widest shadow-xl hover:scale-105 transition-all"
                >
                  Synthesize Curriculum
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      <style>{`
        .marker-font { font-family: 'Permanent Marker', cursive; }
        .handwritten { font-family: 'Caveat', cursive; }
        .animate-fade-in { animation: fadeIn 0.6s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
      `}</style>
    </div>
  );
};

export default CoursesPage;

// END OF FILE: pages/CoursesPage.tsx
// ==========================================================================

// FILE: pages/LessonPage.tsx
// --------------------------------------------------------------------------

// FILE: pages/LessonPage.tsx
// --------------------------------------------------------------------------

import React, { useState, useCallback, useRef, useEffect } from 'react';
import { useParams, useLocation, useNavigate } from 'react-router-dom';
import { GoogleGenAI, Modality, Type, FunctionDeclaration } from '@google/genai';
import { useUser, UserButton } from '@clerk/clerk-react';
import Blackboard from '../components/Blackboard';
import { TeacherStatus, Quiz, GeneratedDiagram } from '../types';
import { decodeAudioData, createBlob, decode } from '../utils/audio';
import { supabase } from '../src/lib/supabase';
import { awardXP, checkDeepDiver, checkFirstStep, checkNightScholar } from '@/src/lib/gamification';

const MODEL_NAME = 'gemini-2.5-flash-native-audio-preview-12-2025';
const IMAGE_MODEL_NAME = 'gemini-3-pro-image-preview';

// --- Tools Configuration ---

const createQuizFn: FunctionDeclaration = {
  name: 'create_quiz',
  parameters: {
    type: Type.OBJECT,
    description: 'Generate an interactive multiple-choice quiz based on the lesson content.',
    properties: {
      title: { type: Type.STRING },
      questions: {
        type: Type.ARRAY,
        items: {
          type: Type.OBJECT,
          properties: {
            question: { type: Type.STRING },
            options: { type: Type.ARRAY, items: { type: Type.STRING } },
            correctAnswerIndex: { type: Type.NUMBER }
          },
          required: ['question', 'options', 'correctAnswerIndex']
        }
      }
    },
    required: ['title', 'questions']
  }
};

const generateDiagramFn: FunctionDeclaration = {
  name: 'generate_educational_diagram',
  parameters: {
    type: Type.OBJECT,
    description: 'Use Nano Banana Pro to create a high-fidelity educational diagram for the chalkboard.',
    properties: {
      description: { type: Type.STRING, description: 'Detailed description. Request isolated cutout on solid pure white background.' },
      topic: { type: Type.STRING, description: 'The specific subject being illustrated.' }
    },
    required: ['description', 'topic']
  }
};

const searchAcademicPapersFn: FunctionDeclaration = {
  name: 'search_academic_papers',
  parameters: {
    type: Type.OBJECT,
    description: 'Deep search for academic papers, PDFs, and peer-reviewed studies.',
    properties: { query: { type: Type.STRING } },
    required: ['query']
  }
};

// --- Helper Functions ---

const base64ToBlob = (base64: string, contentType: string) => {
  const base64String = base64.includes(',') ? base64.split(',')[1] : base64;
  const byteCharacters = atob(base64String);
  const byteNumbers = new Uint8Array(byteCharacters.length);
  for (let i = 0; i < byteCharacters.length; i++) byteNumbers[i] = byteCharacters.charCodeAt(i);
  return new Blob([byteNumbers], { type: contentType });
};

// --- Component ---

const LessonPage: React.FC = () => {
  const { lessonId } = useParams();
  const { state } = useLocation();
  const navigate = useNavigate();
  const { user } = useUser();

  // State
  const [status, setStatus] = useState<TeacherStatus>(TeacherStatus.IDLE);
  const [boardContent, setBoardContent] = useState('');
  const [fullLesson, setFullLesson] = useState('');
  const [thoughts, setThoughts] = useState('');
  const [isWriting, setIsWriting] = useState(false);
  const [userInput, setUserInput] = useState('');
  const [cameraActive, setCameraActive] = useState(false);
  const [currentQuiz, setCurrentQuiz] = useState<Quiz | null>(null);
  const [currentDiagram, setCurrentDiagram] = useState<GeneratedDiagram | null>(null);
  const [activeAction, setActiveAction] = useState<string | null>(null);
  const [isSaving, setIsSaving] = useState(false);
  const [sources, setSources] = useState<any[]>([]);

  // Context State
  const [loadingContext, setLoadingContext] = useState(true);
  const [lessonContext, setLessonContext] = useState<{
    type: 'impromptu' | 'structured';
    title: string;
    courseTitle?: string;
    moduleTitle?: string;
    objectives?: string[];
  } | null>(null);

  // Refs
  const sessionRef = useRef<any>(null);
  const sessionPromiseRef = useRef<Promise<any> | null>(null);
  const inputAudioCtxRef = useRef<AudioContext | null>(null);
  const outputAudioCtxRef = useRef<AudioContext | null>(null);
  const nextStartTimeRef = useRef<number>(0);
  const sourcesRef = useRef<Set<AudioBufferSourceNode>>(new Set());
  const videoRef = useRef<HTMLVideoElement>(null);
  const keepaliveIntervalRef = useRef<number | null>(null);

  // Interrupt Handling
  const userSpeakingRef = useRef(false); // Can likely be removed now, but keeping for state tracking if needed
  
  // Accumulators for saving
  const transcriptAccumulator = useRef("");
  const thoughtAccumulator = useRef("");
  const base64ImagesQueue = useRef<string[]>([]);

  // 1. Data Fetching / Context Setup
  useEffect(() => {
    const fetchContext = async () => {
      if (!lessonId) return;

      // Case A: Impromptu (Topic passed via router state)
      if (state?.topic) {
        setLessonContext({
          type: 'impromptu',
          title: state.topic
        });
        setLoadingContext(false);
        return;
      }

      // Case B: Structured (Fetch from DB)
      try {
        const { data, error } = await supabase
          .from('lesson_plans')
          .select(`
            title,
            learning_objectives,
            modules (
              title,
              courses (
                title,
                description
              )
            )
          `)
          .eq('id', lessonId)
          .single();

        if (error || !data) {
          console.error("Lesson plan not found:", error);
          navigate('/'); // Fallback
          return;
        }

        const moduleData = Array.isArray(data.modules) ? data.modules[0] : data.modules;
        const courseData = Array.isArray(moduleData?.courses) ? moduleData.courses[0] : moduleData?.courses;

        setLessonContext({
          type: 'structured',
          title: data.title,
          moduleTitle: moduleData?.title,
          courseTitle: courseData?.title,
          objectives: data.learning_objectives
        });
      } catch (err) {
        console.error("Context fetch error:", err);
      } finally {
        setLoadingContext(false);
      }
    };

    fetchContext();
  }, [lessonId, state, navigate]);

  // 2. Audio Cleanup & Interaction Handling
  const clearAudioQueue = useCallback(() => {
    console.log('üõë Clearing audio queue - Interruption Detected');
    
    // Stop all audio
    sourcesRef.current.forEach(source => {
      try { source.stop(); source.disconnect(); } catch (e) { }
    });
    sourcesRef.current.clear();
    
    // Reset output timing
    if (outputAudioCtxRef.current) {
      nextStartTimeRef.current = outputAudioCtxRef.current.currentTime;
    }
    
    // UX: Wipe the board on interruption
    setBoardContent(''); 
    
    setIsWriting(false);
  }, []);

  // 3. Stop & Save Session
  const stopSession = useCallback(async () => {
    if (keepaliveIntervalRef.current) {
      clearInterval(keepaliveIntervalRef.current);
      keepaliveIntervalRef.current = null;
    }

    setIsSaving(true);

    if (user && (transcriptAccumulator.current || thoughtAccumulator.current)) {
      const finalUrls: string[] = [];
      
      // A. Upload generated images
      for (const b64 of base64ImagesQueue.current) {
        try {
          const blob = base64ToBlob(b64, 'image/jpeg');
          const path = `${user.id}/${lessonId}_${Math.random().toString(36).substring(7)}.jpg`;
          const { error: upErr } = await supabase.storage.from('seeker').upload(path, blob);
          if (!upErr) {
            const { data: { publicUrl } } = supabase.storage.from('seeker').getPublicUrl(path);
            finalUrls.push(publicUrl);
          }
        } catch (e) { console.error("Image upload failed:", e); }
      }

      // B. Save Lesson
      await supabase.from('lessons').insert({
        lesson_id: lessonId,
        student_id: user.id,
        title: lessonContext?.title || "Untitled Lesson",
        lesson_summary: transcriptAccumulator.current,
        thoughts: thoughtAccumulator.current,
        lesson_images: finalUrls
      });

      // C. Gamification
      try {
        await awardXP(user.id, 50); 
        await checkNightScholar(user.id);
        await checkFirstStep(user.id);
        await checkDeepDiver(user.id);
      } catch (err) { console.error("Gamification error:", err); }
    }

    if (sessionRef.current) try { sessionRef.current.close(); } catch (e) { }
    sessionRef.current = null;
    sessionPromiseRef.current = null;

    [inputAudioCtxRef, outputAudioCtxRef].forEach(ref => {
      if (ref.current && ref.current.state !== 'closed') ref.current.close();
      ref.current = null;
    });

    setIsWriting(false);

    if (videoRef.current?.srcObject) {
      (videoRef.current.srcObject as MediaStream).getTracks().forEach(t => t.stop());
      videoRef.current.srcObject = null;
    }

    setTimeout(() => navigate(`/notes/${lessonId}`), 2500);
  }, [user, lessonId, lessonContext, navigate]);

  // 4. Image Generation
  const handleGenerateImage = async (prompt: string) => {
    try {
      const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
      const optimizedPrompt = `${prompt}. High-quality professional educational illustration, isolated cutout on a SOLID PURE WHITE BACKGROUND. No shadows.`;
      const response = await ai.models.generateContent({ model: IMAGE_MODEL_NAME, contents: optimizedPrompt });
      const part = response.candidates?.[0].content.parts.find(p => p.inlineData);
      if (part?.inlineData) {
        const b64 = `data:${part.inlineData.mimeType};base64,${part.inlineData.data}`;
        base64ImagesQueue.current.push(b64);
        return b64;
      }
    } catch (err) { console.error("Image Gen Failed:", err); }
    return null;
  };

  // 5. Main AI Logic
  useEffect(() => {
    if (loadingContext || !lessonContext || !user) return;

    const initLesson = async () => {
      try {
        setStatus(TeacherStatus.CONNECTING);
        const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
        const AudioCtx = window.AudioContext || (window as any).webkitAudioContext;
        inputAudioCtxRef.current = new AudioCtx({ sampleRate: 16000 });
        outputAudioCtxRef.current = new AudioCtx({ sampleRate: 24000 });

        // UPDATE: Added constraints for Echo Cancellation to prevent self-interruption
        const stream = await navigator.mediaDevices.getUserMedia({
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: true,
          },
          video: { width: 640, height: 480 }
        });

        if (videoRef.current) {
          videoRef.current.srcObject = stream;
          setCameraActive(true);
        }

        // --- CONTEXT ENGINEERING ---
        let finalSystemInstruction = `You are a friendly, patient, and expert virtual AI teacher named Seeker. 
        Your goal is to teach the user via AUDIO. You cannot see the user, so rely on your voice and the blackboard.
        
        CRITICAL RULES:
        1. Keep responses SHORT (15-30 seconds max) - this is a conversation, not a lecture.
        2. After each short explanation, PAUSE and ask "Does that make sense?" or "Should I continue?".
        3. Listen for interruptions.
        4. NEVER queue long monologues.

        Student Name: ${user.firstName}.
        `;

        let initialUserMessage = "";

        if (lessonContext.type === 'structured') {
          finalSystemInstruction += `
          CONTEXT:
          You are the official instructor for the course: "${lessonContext.courseTitle}".
          Current Module: "${lessonContext.moduleTitle}".
          Lesson Topic: "${lessonContext.title}".
          Learning Objectives: ${lessonContext.objectives?.join(', ')}.

          BEHAVIOR:
          Welcome the student to this specific lesson. 
          Briefly state the goal based on the objectives. 
          Do NOT ask "what do you want to learn today". 
          Begin the lesson material immediately after the welcome.
          `;
          initialUserMessage = `I have arrived in the classroom for the lesson: "${lessonContext.title}". Please introduce today's lesson and begin.`;
        } else {
          finalSystemInstruction += `
          CONTEXT:
          The student has initiated an impromptu session on the topic: "${lessonContext.title}".
          
          BEHAVIOR:
          Ask the student what specific aspect of "${lessonContext.title}" they want to explore, or offer a starting point.
          `;
          initialUserMessage = `I want to learn about "${lessonContext.title}". Please start the class.`;
        }

        const sessionPromise = ai.live.connect({
          model: MODEL_NAME,
          config: {
            responseModalities: [Modality.AUDIO],
            systemInstruction: finalSystemInstruction,
            tools: [
              { googleSearch: {} },
              { functionDeclarations: [createQuizFn, generateDiagramFn, searchAcademicPapersFn] }
            ],
            // UPDATE: Removed "Kore" voice config to use default or let model decide, 
            // as some specific voice configs can sometimes cause latency issues. 
            // You can add it back if needed, but simplest is best for debugging.
            speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: 'Kore' } } },
            outputAudioTranscription: {},
          },
          callbacks: {
            onopen: () => {
              setStatus(TeacherStatus.TEACHING);

              // Force Speak First
              if (sessionRef.current) {
                console.log("üöÄ Sending initial context trigger...");
                sessionRef.current.sendClientContent({
                  turns: [{ role: 'user', parts: [{ text: initialUserMessage }] }],
                  turnComplete: true
                });
              }

              // Audio Input Setup
              const source = inputAudioCtxRef.current!.createMediaStreamSource(stream);
              const scriptProcessor = inputAudioCtxRef.current!.createScriptProcessor(4096, 1, 1);
              
              // UPDATE: Removed manual Volume calculation logic (average > 20).
              // We now trust Gemini's VAD entirely.
              scriptProcessor.onaudioprocess = (e) => {
                if (sessionRef.current) {
                  try {
                    sessionRef.current.sendRealtimeInput({
                      media: createBlob(e.inputBuffer.getChannelData(0))
                    });
                  } catch (err) {
                     // ignore if session closed
                  }
                }
              };

              source.connect(scriptProcessor);
              scriptProcessor.connect(inputAudioCtxRef.current!.destination);

              // Keepalive
              keepaliveIntervalRef.current = window.setInterval(() => {
                if (sessionRef.current) {
                  const silentBuffer = new Float32Array(160);
                  try {
                    sessionRef.current.sendRealtimeInput({ media: createBlob(silentBuffer) });
                  } catch (err) { }
                }
              }, 5000);
            },

            onmessage: async (m: any) => {
              // Transcript
              if (m.serverContent?.outputTranscription) {
                const text = m.serverContent.outputTranscription.text;
                transcriptAccumulator.current += text;
                // Append to board
                setBoardContent(p => p + text);
                setFullLesson(p => p + text);
              }

              // Thoughts
              if (m.serverContent?.modelTurn?.parts) {
                for (const p of m.serverContent.modelTurn.parts) {
                  if (p.thought) {
                    thoughtAccumulator.current += p.text;
                    setThoughts(t => t + p.text);
                  }
                }
              }

              // Audio Output
              const audio = m.serverContent?.modelTurn?.parts?.[0]?.inlineData?.data;
              if (audio && outputAudioCtxRef.current && outputAudioCtxRef.current.state !== 'closed') {
                
                setIsWriting(true);
                try {
                  const buf = await decodeAudioData(decode(audio), outputAudioCtxRef.current, 24000, 1);
                  const src = outputAudioCtxRef.current.createBufferSource();
                  src.buffer = buf;
                  src.connect(outputAudioCtxRef.current.destination);

                  src.onended = () => {
                    sourcesRef.current.delete(src);
                    if (sourcesRef.current.size === 0) setIsWriting(false);
                  };

                  const now = outputAudioCtxRef.current.currentTime;
                  nextStartTimeRef.current = Math.max(now, nextStartTimeRef.current);
                  src.start(nextStartTimeRef.current);
                  nextStartTimeRef.current += buf.duration;
                  sourcesRef.current.add(src);
                } catch (err) { setIsWriting(false); }
              }

              // Tools
              if (m.toolCall) {
                for (const fc of m.toolCall.functionCalls) {
                  setActiveAction(fc.name.replace(/_/g, ' '));

                  if (fc.name === 'create_quiz') {
                    setCurrentQuiz(fc.args as Quiz);
                    if (sessionRef.current) sessionRef.current.sendToolResponse({ functionResponses: { id: fc.id, name: fc.name, response: { result: "Quiz displayed." } } });
                  }
                  else if (fc.name === 'generate_educational_diagram') {
                    if (sessionRef.current) sessionRef.current.sendToolResponse({ functionResponses: { id: fc.id, name: fc.name, response: { result: "Generating diagram..." } } });
                    handleGenerateImage(fc.args.description).then(url => {
                      if (url) setCurrentDiagram({ url, topic: fc.args.topic });
                    });
                  }
                  else if (fc.name === 'search_academic_papers') {
                    setSources(prev => [{
                      title: `PAPER: ${fc.args.query}`,
                      uri: `https://scholar.google.com/scholar?q=${encodeURIComponent(fc.args.query)}`,
                      isAcademic: true
                    }, ...prev]);
                    if (sessionRef.current) sessionRef.current.sendToolResponse({ functionResponses: { id: fc.id, name: fc.name, response: { result: "Sources found." } } });
                  }
                  setTimeout(() => setActiveAction(null), 3000);
                }
              }

              // Server-Side VAD (Interruption Handling)
              // This is the correct way to handle interruptions
              if (m.serverContent?.interrupted) {
                clearAudioQueue();
              }
            },

            onerror: (e) => {
              console.error('Session error:', e);
              setStatus(TeacherStatus.ERROR);
            },

            onclose: () => {
              if (keepaliveIntervalRef.current) {
                clearInterval(keepaliveIntervalRef.current);
                keepaliveIntervalRef.current = null;
              }
            }
          }
        });

        sessionPromiseRef.current = sessionPromise;
        sessionRef.current = await sessionPromise;

      } catch (err) {
        console.error('Init error:', err);
        setStatus(TeacherStatus.IDLE);
      }
    };

    initLesson();

    return () => {
      if (keepaliveIntervalRef.current) clearInterval(keepaliveIntervalRef.current);
      if (sessionRef.current) try { sessionRef.current.close(); } catch (e) { }
    };
  }, [loadingContext, lessonContext, user, clearAudioQueue]);

  if (loadingContext) {
    return (
      <div className="h-screen bg-[#1a1a1a] flex flex-col items-center justify-center space-y-6">
        <div className="w-16 h-16 border-4 border-yellow-400 border-t-transparent rounded-full animate-spin" />
        <p className="marker-font text-yellow-400 text-2xl animate-pulse uppercase">Consulting Curriculum...</p>
      </div>
    );
  }

  return (
    <div className="flex flex-col h-screen w-full bg-[#1a1a1a] text-white overflow-hidden relative font-sans">
      {isSaving && (
        <div className="fixed inset-0 z-[200] bg-black/90 backdrop-blur-2xl flex flex-col items-center justify-center space-y-8 text-center px-4">
          <div className="w-24 h-24 border-8 border-green-500 border-t-transparent rounded-full animate-spin shadow-[0_0_60px_rgba(34,197,94,0.3)]" />
          <div className="space-y-2">
            <h2 className="marker-font text-5xl text-green-500 animate-pulse uppercase tracking-tighter">Archiving Lecture</h2>
            <p className="handwritten text-2xl text-white/40 italic">Seeker is preparing your personal notebook.</p>
          </div>
        </div>
      )}

      {activeAction && (
        <div className="fixed top-24 left-1/2 -translate-x-1/2 z-[100] bg-yellow-400 text-black px-6 py-3 rounded-full font-bold shadow-2xl animate-bounce border-2 border-black text-xs uppercase tracking-widest">
          AI Action: {activeAction}
        </div>
      )}

      <header className="p-4 md:px-8 border-b border-white/10 bg-[#1e1e1e]/50 backdrop-blur-xl z-40 flex items-center justify-between">
        <div className="flex items-center gap-3">
          <div className="w-8 h-8 bg-green-600 rounded-lg flex items-center justify-center border border-white/20">
            <svg className="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>
          </div>
          <div className="flex flex-col">
            <span className="text-[10px] text-green-500 font-bold uppercase tracking-widest">
              {lessonContext?.type === 'structured' ? `${lessonContext.courseTitle} / ${lessonContext.moduleTitle}` : 'Impromptu Session'}
            </span>
            <h1 className="text-xl font-bold uppercase tracking-tight leading-none text-white">
              {lessonContext?.title}
            </h1>
          </div>
        </div>
        <div className="flex items-center gap-4">
          <button
            onClick={clearAudioQueue}
            className="px-4 py-2 bg-yellow-500/10 text-yellow-400 border border-yellow-500/20 rounded-full text-xs font-bold uppercase tracking-widest hover:bg-yellow-500 hover:text-black transition-all shadow-lg"
          >
            Skip Response
          </button>
          <button onClick={stopSession} className="px-6 py-2 bg-red-500/10 text-red-400 border border-red-500/20 rounded-full text-xs font-bold uppercase tracking-widest hover:bg-red-500 hover:text-white transition-all shadow-lg">End Lesson</button>
          <UserButton />
        </div>
      </header>

      <main className="flex-1 flex flex-col relative bg-[#161616] min-h-0">
        <Blackboard
          content={boardContent}
          fullLesson={fullLesson}
          thoughts={thoughts}
          isWriting={isWriting}
          topic={lessonContext?.title}
          quiz={currentQuiz}
          diagram={currentDiagram}
          // Removed onOverflow since we now auto-scroll
          onCloseQuiz={() => setCurrentQuiz(null)}
          onCloseDiagram={() => setCurrentDiagram(null)}
          onQuizComplete={() => { }}
        />

        {sources.length > 0 && (
          <div className="px-8 pb-4 flex flex-wrap gap-2 overflow-y-auto max-h-24 z-20">
            {sources.map((s, i) => (
              <a key={i} href={s.uri} target="_blank" rel="noopener noreferrer" className="border px-3 py-1 rounded-lg text-[10px] uppercase font-bold tracking-widest bg-white/5 border-white/10 hover:bg-white/10 transition-all text-white/60">
                {s.title}
              </a>
            ))}
          </div>
        )}

        {cameraActive && (
          <div className="absolute top-6 right-6 w-44 h-32 rounded-2xl border-4 border-white/10 shadow-2xl overflow-hidden bg-black z-30 transition-all hover:scale-105 shadow-green-500/10">
            <video ref={videoRef} autoPlay playsInline muted className="w-full h-full object-cover grayscale brightness-110" />
            <div className="absolute inset-0 bg-green-500/5 pointer-events-none" />
          </div>
        )}
      </main>

      <footer className="p-4 md:p-6 border-t border-white/10 bg-[#1e1e1e] z-40">
        <div className="max-w-4xl mx-auto">
          <input
            type="text"
            placeholder="Speak to Seeker or type a question here..."
            value={userInput}
            onChange={(e) => setUserInput(e.target.value)}
            onKeyDown={(e) => {
              if (e.key === 'Enter' && userInput.trim() && sessionRef.current) {
                // Manually clearing queue triggers the board wipe
                clearAudioQueue(); 
                try {
                  sessionRef.current.sendClientContent({
                    turns: [{ role: 'user', parts: [{ text: userInput }] }],
                    turnComplete: true
                  });
                  setUserInput('');
                } catch (err) {
                  console.error("Send input error:", err);
                }
              }
            }}
            className="w-full bg-white/5 border border-white/10 rounded-2xl px-6 py-4 handwritten text-2xl focus:ring-2 focus:ring-green-500 placeholder:text-white/10 transition-all"
          />
        </div>
      </footer>
    </div>
  );
};

export default LessonPage;

// END OF FILE: pages/LessonPage.tsx
// ==========================================================================

// FILE: pages/NotesPage.tsx
// --------------------------------------------------------------------------

// FILE: pages/NotesPage.tsx
// --------------------------------------------------------------------------

import React, { useEffect, useState, useRef } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { GoogleGenAI } from '@google/genai';
import { useUser } from '@clerk/clerk-react';
import { supabase } from '../src/lib/supabase';
import IntelligentMarkdown from '@/components/IntelligentMarkdown';
import CertificateView from '@/components/CertificateView'; 

const IMAGE_MODEL_NAME = 'gemini-3-pro-image-preview'; 
const TEXT_MODEL_NAME = 'gemini-3-pro-preview'; 

const base64ToBlob = (base64: string, contentType: string) => {
  const base64String = base64.includes(',') ? base64.split(',')[1] : base64;
  const byteCharacters = atob(base64String);
  const byteNumbers = new Array(byteCharacters.length);
  for (let i = 0; i < byteCharacters.length; i++) byteNumbers[i] = byteCharacters.charCodeAt(i);
  return new Blob([new Uint8Array(byteNumbers)], { type: contentType });
};

const NotesPage: React.FC = () => {
  const { lessonId } = useParams();
  const navigate = useNavigate();
  const { user } = useUser();

  const [lesson, setLesson] = useState<any>(null);
  const [isGeneratingBanner, setIsGeneratingBanner] = useState(false);
  const [isPolishing, setIsPolishing] = useState(false);
  const [showOriginal, setShowOriginal] = useState(false);
  const [showComic, setShowComic] = useState(false); 
  const [currentSlide, setCurrentSlide] = useState(1);
  const [showAudioPlayer, setShowAudioPlayer] = useState(false);
  const [isPlaying, setIsPlaying] = useState(false);
  const [audioProgress, setAudioProgress] = useState(0);
  const [audioDuration, setAudioDuration] = useState(0);
  const [audioCurrentTime, setAudioCurrentTime] = useState(0);

  // --- PROGRESSION STATE ---
  const [currentPlan, setCurrentPlan] = useState<any>(null);
  const [nextPlan, setNextPlan] = useState<any>(null);

  // --- MODAL STATES ---
  const [selectedComicIndex, setSelectedComicIndex] = useState<number | null>(null);
  
  const videoRef = useRef<HTMLVideoElement>(null);
  const audioRef = useRef<HTMLAudioElement>(null);
  
  const cinemaTriggered = useRef(false);
  const animatedTriggered = useRef(false);
  const bannerTriggered = useRef(false);
  const notesTriggered = useRef(false);
  const podcastTriggered = useRef(false);
  const comicTriggered = useRef(false);

  useEffect(() => {
    document.body.style.overflow = 'auto';
    document.documentElement.style.overflow = 'auto';
    return () => {
      document.body.style.overflow = 'hidden';
      document.documentElement.style.overflow = 'hidden';
    };
  }, []);

  // Podcast Audio Listeners
  useEffect(() => {
    const audio = audioRef.current;
    if (!audio || !lesson?.podcast_url) return;
    const updateProgress = () => {
      if (audio.duration) {
        setAudioCurrentTime(audio.currentTime);
        setAudioProgress((audio.currentTime / audio.duration) * 100);
      }
    };
    const handleLoadedMetadata = () => setAudioDuration(audio.duration);
    const handlePlay = () => setIsPlaying(true);
    const handlePause = () => setIsPlaying(false);
    const handleEnded = () => setIsPlaying(false);
    audio.addEventListener('timeupdate', updateProgress);
    audio.addEventListener('loadedmetadata', handleLoadedMetadata);
    audio.addEventListener('play', handlePlay);
    audio.addEventListener('pause', handlePause);
    audio.addEventListener('ended', handleEnded);
    return () => {
      audio.removeEventListener('timeupdate', updateProgress);
      audio.removeEventListener('loadedmetadata', handleLoadedMetadata);
      audio.removeEventListener('play', handlePlay);
      audio.removeEventListener('pause', handlePause);
      audio.removeEventListener('ended', handleEnded);
    };
  }, [lesson?.podcast_url]);

  useEffect(() => {
    const fetchAndTrigger = async () => {
      const { data } = await supabase.from('lessons').select('*').eq('lesson_id', lessonId).single();
      if (!data) return;
      setLesson(data);

      const { data: planData } = await supabase.from('lesson_plans').select('*').eq('id', lessonId).single();
      if (planData) {
        setCurrentPlan(planData);
        const { data: next } = await supabase
          .from('lesson_plans')
          .select('*')
          .eq('module_id', planData.module_id)
          .eq('order_index', planData.order_index + 1)
          .single();
        setNextPlan(next);
      }

      if (!data.banner_image && !bannerTriggered.current) {
        bannerTriggered.current = true;
        generateAndUploadBanner(data.title);
      }
      if (!data.ai_notes && !notesTriggered.current) {
        notesTriggered.current = true;
        handlePolishing(data.lesson_summary, data.thoughts);
      }
      if (data.video_status === 'idle' && !cinemaTriggered.current) {
        cinemaTriggered.current = true;
        fetch('https://seeker-server-tn3b.onrender.com/slides/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ lessonId, summary: data.lesson_summary, thoughts: data.thoughts, title: data.title })
        }).catch(err => console.error(err));
      }
      if ((!data.podcast_status || data.podcast_status === 'idle') && !data.podcast_url && !podcastTriggered.current) {
        podcastTriggered.current = true;
        fetch('https://seeker-server-tn3b.onrender.com/slides/generate-podcast', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ lessonId, summary: data.lesson_summary, title: data.title })
        }).catch(err => console.error(err));
      }
      if ((!data.animated_video_status || data.animated_video_status === 'idle') && !data.animated_video_url && !animatedTriggered.current) {
        animatedTriggered.current = true;
        fetch('https://seeker-server-tn3b.onrender.com/video/generate-cinematic', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ lessonId, summary: data.lesson_summary, title: data.title, studentId: data.student_id })
        }).catch(err => console.error(err));
      }
    };

    fetchAndTrigger();

    const channel = supabase.channel(`notes_sync_${lessonId}`)
      .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'lessons', filter: `lesson_id=eq.${lessonId}` }, (p) => setLesson(p.new))
      .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'lesson_plans', filter: `id=eq.${lessonId}` }, (p) => setCurrentPlan(p.new))
      .subscribe();

    return () => { supabase.removeChannel(channel); };
  }, [lessonId]);

  // Comic Navigation Handlers
  const nextComic = (e?: React.MouseEvent) => {
    e?.stopPropagation();
    if (selectedComicIndex !== null && selectedComicIndex < lesson.comic_pages.length - 1) {
      setSelectedComicIndex(selectedComicIndex + 1);
    }
  };

  const prevComic = (e?: React.MouseEvent) => {
    e?.stopPropagation();
    if (selectedComicIndex !== null && selectedComicIndex > 0) {
      setSelectedComicIndex(selectedComicIndex - 1);
    }
  };

  const handleComicToggle = () => {
    if (!showComic && (!lesson.comic_pages || lesson.comic_pages.length === 0) && !comicTriggered.current) {
      comicTriggered.current = true;
      fetch('https://seeker-server-tn3b.onrender.com/slides/generate-comic', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ lessonId, ai_notes: lesson.ai_notes, title: lesson.title })
      }).catch(err => console.error("Comic Trigger Error:", err));
    }
    setShowComic(!showComic);
  };

  const generateAndUploadBanner = async (title: string) => {
    setIsGeneratingBanner(true);
    try {
      const ai = new GoogleGenAI({ apiKey: process.env.API_KEY || '' });
      const response = await ai.models.generateContent({ 
        model: IMAGE_MODEL_NAME, 
        contents: [{ role: 'user', parts: [{ text: `High-detail wide academic banner for "${title}". No text.` }] }]
      });
      const part = response.candidates?.[0].content.parts.find(p => p.inlineData);
      if (part?.inlineData) {
        const blob = base64ToBlob(part.inlineData.data, part.inlineData.mimeType);
        const fileName = `banners/${lessonId}_banner.jpg`;
        await supabase.storage.from('seeker').upload(fileName, blob, { upsert: true });
        const { data: { publicUrl } } = supabase.storage.from('seeker').getPublicUrl(fileName);
        await supabase.from('lessons').update({ banner_image: publicUrl }).eq('lesson_id', lessonId);
        setLesson((prev: any) => ({ ...prev, banner_image: publicUrl }));
      }
    } catch (e) { console.error(e); } finally { setIsGeneratingBanner(false); }
  };

  const handlePolishing = async (summary: string, thoughts: string) => {
    setIsPolishing(true);
    try {
      const ai = new GoogleGenAI({ apiKey: process.env.API_KEY || '' });
      const prompt = `Expert academic note-taker. Transform this to Markdown study notes. THOUGHTS: ${thoughts} | TRANSCRIPT: ${summary}`;
      const response = await ai.models.generateContent({ model: TEXT_MODEL_NAME, contents: [{ role: 'user', parts: [{ text: prompt }] }] });
      const text = response.candidates?.[0]?.content?.parts?.[0]?.text;
      if (text) {
        await supabase.from('lessons').update({ ai_notes: text }).eq('lesson_id', lessonId);
        setLesson((prev: any) => ({ ...prev, ai_notes: text }));
      }
    } catch (e) { console.error(e); } finally { setIsPolishing(false); }
  };

  const togglePublic = async () => {
    const newState = !lesson.is_public;
    await supabase.from('lessons').update({ is_public: newState }).eq('lesson_id', lessonId);
    setLesson((prev: any) => ({ ...prev, is_public: newState }));
  };

  const handleShare = async () => {
    if (!lesson.is_public) return alert("Enable 'Public Access' first.");
    const url = window.location.href;
    if (navigator.share) await navigator.share({ title: lesson.title, url });
    else { navigator.clipboard.writeText(url); alert("Link Copied!"); }
  };

  const formatTime = (seconds: number) => `${Math.floor(seconds / 60)}:${Math.floor(seconds % 60).toString().padStart(2, '0')}`;

  const handleProgressClick = (e: React.MouseEvent<HTMLDivElement>) => {
    const audio = audioRef.current;
    if (!audio) return;
    const rect = e.currentTarget.getBoundingClientRect();
    const percentage = (e.clientX - rect.left) / rect.width;
    audio.currentTime = percentage * audio.duration;
  };

  if (!lesson) return <div className="h-screen bg-[#f4f1ea] flex items-center justify-center font-bold text-gray-400 uppercase tracking-widest animate-pulse">Consulting Archives...</div>;

  const contentToDisplay = (isPolishing || showOriginal || !lesson.ai_notes) ? lesson.lesson_summary : lesson.ai_notes;
  
  // Ownership Check
  const isOwner = user?.id === lesson?.student_id;

  return (
    <div className="flex flex-col lg:flex-row w-full min-h-screen h-auto overflow-auto bg-[#e5e7eb] font-sans text-gray-900 overscroll-contain">
      
      {/* LEFT SIDEBAR: LESSON IMAGES */}
      <aside className="w-full lg:w-72 bg-[#d1d5db] p-6 shrink-0 lg:h-full lg:overflow-y-auto lg:border-r border-gray-300 shadow-inner">
        <h3 className="marker-font text-gray-500 uppercase text-xs mb-8 tracking-widest text-center">Visual Aids</h3>
        <div className="flex lg:flex-col gap-8 overflow-x-auto lg:overflow-x-visible pb-4 lg:pb-0">
          {lesson.lesson_images?.map((url: string, i: number) => (
            <div key={i} className="min-w-[240px] lg:min-w-0 bg-white p-2 shadow-xl border-4 border-white rotate-1 hover:rotate-0 transition-all duration-500">
              <img src={url} className="w-full h-auto grayscale-[0.2] hover:grayscale-0 transition-all" alt="Lecture Aid" />
            </div>
          ))}
        </div>
      </aside>

      {/* CENTER: THE NOTEBOOK VIEW */}
      <main className="flex-1 bg-[#f4f1ea] lg:h-full lg:overflow-y-auto scroll-smooth">
        <div className="max-w-4xl mx-auto py-8 lg:py-16 px-4 sm:px-10">
          
          <div className="w-full h-32 sm:h-56 mb-8 relative rounded-3xl overflow-hidden shadow-2xl bg-gray-200 border-4 border-white">
            {isGeneratingBanner ? (
              <div className="absolute inset-0 bg-gray-800 flex items-center justify-center">
                <div className="w-8 h-8 border-2 border-white/20 border-t-white rounded-full animate-spin" />
              </div>
            ) : lesson.banner_image && <img src={lesson.banner_image} className="w-full h-full object-cover" alt="Banner" />}
          </div>

          <div className="bg-white shadow-2xl rounded-sm relative border-l-[40px] sm:border-l-[80px] border-red-50 pb-20 overflow-hidden">
            <div className="absolute inset-0 pointer-events-none opacity-40" style={{ background: 'linear-gradient(rgba(173, 216, 230, 0.4) 1px, transparent 1px)', backgroundSize: '100% 2.5rem' }} />

            <div className="relative z-10 px-8 sm:px-16 py-12">
              <header className="flex flex-col sm:flex-row justify-between items-start border-b-4 border-gray-100 mb-12 pb-10 gap-8">
                <div className="space-y-4">
                  <div className="flex items-center gap-4">
                    <h1 className="marker-font text-4xl sm:text-6xl text-gray-800 uppercase leading-tight tracking-tighter">{lesson.title}</h1>
                    {lesson.podcast_url && (
                      <button onClick={() => setShowAudioPlayer(!showAudioPlayer)} className="w-12 h-12 bg-yellow-500 hover:bg-yellow-600 rounded-full flex items-center justify-center shadow-lg shadow-yellow-500/30 transition-all hover:scale-110 active:scale-95">
                        <svg className="w-6 h-6 text-black" fill="currentColor" viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
                      </button>
                    )}
                  </div>
                  
                  {showAudioPlayer && lesson.podcast_url && (
                    <div className="bg-white/80 backdrop-blur-sm rounded-2xl p-4 shadow-lg border border-yellow-500/20 max-w-md">
                      <audio ref={audioRef} src={lesson.podcast_url} className="hidden" preload="metadata" />
                      <div className="flex items-center gap-3">
                        <button onClick={() => audioRef.current?.paused ? audioRef.current?.play() : audioRef.current?.pause()} className="w-10 h-10 bg-yellow-500 hover:bg-yellow-600 rounded-full flex items-center justify-center shadow-md transition-all">
                          {isPlaying ? <svg className="w-5 h-5 text-black" fill="currentColor" viewBox="0 0 24 24"><path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/></svg> : <svg className="w-5 h-5 text-black ml-0.5" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>}
                        </button>
                        <div className="flex-1 h-1.5 bg-gray-200 rounded-full overflow-hidden cursor-pointer" onClick={handleProgressClick}>
                          <div className="h-full bg-yellow-500 transition-all duration-100" style={{ width: `${audioProgress || 0}%` }} />
                        </div>
                        <span className="text-xs font-mono text-gray-500 w-16 text-right tabular-nums">{formatTime(audioCurrentTime || 0)}</span>
                        <span className="text-xs font-mono text-gray-400">/</span>
                        <span className="text-xs font-mono text-gray-400 w-16 tabular-nums">{formatTime(audioDuration || 0)}</span>
                      </div>
                    </div>
                  )}
                  
                  <div className="flex flex-wrap items-center gap-6">
                    <label className="relative inline-flex items-center cursor-pointer scale-90 origin-left">
                        <input type="checkbox" className="sr-only peer" checked={showOriginal} onChange={() => setShowOriginal(!showOriginal)} />
                        <div className="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        <span className="ml-3 text-[10px] font-black text-gray-400 uppercase tracking-widest">Original Transcript</span>
                    </label>

                    <label className="relative inline-flex items-center cursor-pointer scale-90 origin-left">
                        <input type="checkbox" className="sr-only peer" checked={showComic} onChange={handleComicToggle} />
                        <div className="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-yellow-500"></div>
                        <span className="ml-3 text-[10px] font-black text-gray-400 uppercase tracking-widest">Comic Mode</span>
                    </label>

                    {/* Only Owner can toggle Public Access */}
                    {isOwner && (
                      <label className="relative inline-flex items-center cursor-pointer scale-90 origin-left">
                          <input type="checkbox" className="sr-only peer" checked={lesson.is_public} onChange={togglePublic} />
                          <div className="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                          <span className="ml-3 text-[10px] font-black text-gray-400 uppercase tracking-widest">Public Access</span>
                      </label>
                    )}
                  </div>
                </div>
                <div className="flex gap-2 w-full sm:w-auto">
                    {isOwner && <button onClick={handleShare} className={`flex-1 sm:flex-none px-6 py-2 rounded-lg text-xs font-bold uppercase transition-all border ${lesson.is_public ? 'bg-blue-50 text-blue-600 border-blue-100 hover:bg-blue-100' : 'bg-gray-100 text-gray-300 border-gray-100 cursor-not-allowed'}`}>SHARE</button>}
                    <button onClick={() => navigate(isOwner ? '/archive' : '/notice-board')} className="flex-1 sm:flex-none px-8 py-2 bg-gray-900 text-white rounded-lg text-xs font-bold uppercase shadow-xl hover:scale-105 transition-all">EXIT</button>
                </div>
              </header>

              <article className="relative min-h-[300px]">
                {showComic ? (
                  <div className="space-y-16 animate-fade-in pb-20">
                    {lesson.comic_status === 'processing' ? (
                      <div className="py-32 text-center flex flex-col items-center">
                          <div className="w-20 h-20 border-8 border-yellow-400 border-t-transparent rounded-full animate-spin mb-8 shadow-[0_0_40px_rgba(250,204,21,0.2)]" />
                          <h3 className="marker-font text-4xl text-yellow-600 animate-pulse uppercase">Banana Sensei is Drawing...</h3>
                          <p className="handwritten text-2xl text-gray-400 italic mt-4">Maintaining visual anchors & continuity.</p>
                      </div>
                    ) : lesson.comic_pages?.length > 0 ? (
                      <div className="grid grid-cols-1 gap-12">
                        {lesson.comic_pages.map((url: string, i: number) => (
                          <div 
                            key={i} 
                            onClick={() => setSelectedComicIndex(i)}
                            className="group relative bg-white p-4 shadow-[30px_30px_0px_rgba(0,0,0,0.08)] border-4 border-black transition-all hover:scale-[1.01] hover:-rotate-1 cursor-zoom-in"
                          >
                              <img src={url} className="w-full h-auto object-cover" alt={`Comic Page ${i+1}`} />
                              <div className="absolute -bottom-6 -right-6 bg-yellow-400 border-4 border-black px-6 py-2 marker-font text-2xl uppercase shadow-xl">
                                  Page {i + 1}
                              </div>
                          </div>
                        ))}
                      </div>
                    ) : (
                      <div className="py-32 text-center text-gray-300 marker-font text-3xl uppercase">Waiting for Sketchbook...</div>
                    )}
                  </div>
                ) : (
                  <>
                    {isPolishing && (
                      <div className="absolute inset-0 z-20 pointer-events-none overflow-hidden">
                        <div className="w-full h-1 bg-blue-400 shadow-[0_0_25px_rgba(96,165,250,1)] animate-beam-scan absolute top-0" />
                      </div>
                    )}
                    <div className={`handwritten prose prose-2xl max-w-none transition-opacity duration-1000 ${isPolishing ? 'opacity-40' : 'opacity-100'}`}>
                    <IntelligentMarkdown content={contentToDisplay} />
                    </div>
                  </>
                )}
              </article>

              <section className="mt-20 pt-16 border-t-8 border-gray-50">
                <div className="bg-[#062012] rounded-[40px] overflow-hidden shadow-2xl border-4 border-[#22c55e]/30 relative">
                  <div className="p-4 bg-black/40 flex justify-between items-center border-b border-white/5">
                    <div className="flex items-center gap-3"><div className="w-2.5 h-2.5 bg-[#22c55e] rounded-full animate-pulse shadow-[0_0_10px_#22c55e]" /><span className="marker-font text-white uppercase text-xs tracking-widest">Slide Presentation</span></div>
                  </div>
                  <div className="aspect-video bg-black flex items-center justify-center">
                    {lesson.video_status === 'processing' ? <div className="text-center space-y-6"><div className="w-16 h-16 border-4 border-[#22c55e] border-t-transparent rounded-full animate-spin mx-auto" /><p className="marker-font text-[#22c55e] text-2xl animate-pulse uppercase">Animating Lecture...</p></div> : lesson.video_url ? <video ref={videoRef} src={lesson.video_url} controls className="w-full h-full" onTimeUpdate={() => setCurrentSlide(Math.floor(videoRef.current!.currentTime / 30) + 1)} /> : <div className="text-white/10 marker-font text-2xl uppercase">Pending...</div>}
                  </div>
                  {lesson.video_url && (
                    <div className="p-6 bg-black/60 flex items-center gap-8">
                      <div className="flex-1 flex gap-1 h-1.5">{lesson.video_manifest?.map((_: any, i: number) => (<div key={i} className={`flex-1 rounded-full transition-all duration-700 ${i + 1 <= currentSlide ? 'bg-[#22c55e] shadow-[0_0_10px_#22c55e]' : 'bg-white/10'}`} />))}</div>
                      <div className="marker-font text-[#22c55e] text-lg whitespace-nowrap tracking-tighter">SLIDE <span className="text-white text-3xl">{currentSlide}</span> / {lesson.video_manifest?.length}</div>
                    </div>
                  )}
                </div>
              </section>

              <section className="mt-20 pt-16 border-t-8 border-gray-50">
                <div className="bg-[#1a1a1a] rounded-[40px] overflow-hidden shadow-2xl border-4 border-yellow-500/30 relative">
                  <div className="p-4 bg-black/40 flex justify-between items-center border-b border-white/5">
                    <div className="flex items-center gap-3"><div className="w-2.5 h-2.5 bg-yellow-500 rounded-full animate-pulse shadow-[0_0_10px_#facc15]" /><span className="marker-font text-white uppercase text-xs tracking-widest">Cinematic Explainer</span></div>
                  </div>
                  <div className="aspect-video bg-black flex items-center justify-center">
                    {lesson.animated_video_status === 'processing' ? <div className="text-center space-y-6 p-10"><div className="w-16 h-16 border-4 border-yellow-500 border-t-transparent rounded-full animate-spin mx-auto" /><p className="marker-font text-yellow-500 text-2xl animate-pulse uppercase">Veo is filming...</p></div> : lesson.animated_video_url ? <video src={lesson.animated_video_url} controls className="w-full h-full" /> : <div className="text-white/10 marker-font text-2xl uppercase">Studio initializing...</div>}
                  </div>
                  {lesson.animated_video_url && <div className="p-4 bg-yellow-500/10 border-t border-yellow-500/20"><p className="text-[10px] text-yellow-500/60 font-black uppercase tracking-widest text-center">Synthesized with Google Veo 3.1 & Lyria</p></div>}
                </div>
              </section>

              {/* PROGRESSION & CERTIFICATION SECTION - ONLY VISIBLE TO OWNER */}
              {isOwner && (
                <section className="mt-24 pb-20 border-t-8 border-gray-100 pt-16">
                  <div className="max-w-2xl mx-auto space-y-12">
                    
                    {/* Exam Module / Certificate */}
                    <div className="bg-white p-10 rounded-[3rem] shadow-2xl border-2 border-dashed border-gray-200 text-center space-y-6">
                      <h3 className="marker-font text-3xl text-gray-400 uppercase">Certification</h3>
                      
                      {currentPlan?.status !== 'completed' ? (
                        <div className="space-y-4">
                          <p className="handwritten text-2xl text-gray-500">Ready to prove your mastery?</p>
                          <button 
                            onClick={() => navigate(`/test/${lessonId}`)}
                            className="px-12 py-6 bg-yellow-400 text-black rounded-2xl marker-font text-2xl uppercase shadow-2xl hover:scale-105 transition-all flex items-center gap-4 mx-auto"
                          >
                            Begin Oral Exam
                            <span className="material-symbols-outlined animate-pulse">mic</span>
                          </button>
                        </div>
                      ) : (
                        // INLINE CERTIFICATE DISPLAY
                        <CertificateView
                          userName={user ? (user.fullName || user.firstName || "Seeker Student") : "Seeker Student"}
                          topicTitle={lesson.title}
                          completionDate={new Date().toLocaleDateString()}
                        />
                      )}
                    </div>

                    {/* Progression Module */}
                    <div className="space-y-4">
                      <div className="flex justify-between items-center px-4">
                        <span className="text-[10px] font-black text-gray-300 uppercase tracking-widest">The Next Chapter</span>
                        <span className={`text-[10px] font-black uppercase ${currentPlan?.status === 'completed' ? 'text-green-500' : 'text-red-400'}`}>
                          {currentPlan?.status === 'completed' ? 'Unlocked' : 'Locked'}
                        </span>
                      </div>

                      <button 
                        disabled={currentPlan?.status !== 'completed' || !nextPlan}
                        onClick={() => navigate(`/lesson/${nextPlan.id}`, { state: { topic: nextPlan.title } })}
                        className={`w-full p-10 rounded-[2.5rem] marker-font text-4xl uppercase transition-all flex items-center justify-between group
                          ${currentPlan?.status === 'completed' && nextPlan 
                            ? 'bg-gray-900 text-white hover:bg-green-600 shadow-2xl active:scale-95' 
                            : 'bg-gray-100 text-gray-300 cursor-not-allowed grayscale'}`}
                      >
                        <div className="text-left">
                          <span className="text-[10px] block opacity-40 mb-2">Block {currentPlan?.order_index + 2}</span>
                          {nextPlan ? nextPlan.title : "Academy Completed"}
                        </div>
                        <span className="material-symbols-outlined text-5xl group-hover:translate-x-4 transition-transform">
                          {currentPlan?.status === 'completed' ? 'arrow_forward' : 'lock'}
                        </span>
                      </button>

                      {currentPlan?.status !== 'completed' && (
                        <p className="text-center handwritten text-xl text-gray-400 italic mt-4">
                          Pass the head examiner's test to continue your education.
                        </p>
                      )}
                    </div>
                  </div>
                </section>
              )}

            </div>
          </div>
        </div>
      </main>

      {/* COMIC FULL-SCREEN OVERLAY */}
      {selectedComicIndex !== null && (
        <div 
          className="fixed inset-0 z-[200] bg-black/95 backdrop-blur-xl flex items-center justify-center p-4 md:p-12 animate-fade-in"
          onClick={() => setSelectedComicIndex(null)}
        >
          {/* Close Button */}
          <button className="absolute top-8 right-8 text-white/40 hover:text-white transition-colors">
            <span className="material-symbols-outlined text-5xl">close</span>
          </button>

          {/* Navigation - Previous */}
          {selectedComicIndex > 0 && (
            <button 
              onClick={prevComic}
              className="absolute left-4 md:left-10 z-10 w-16 h-16 bg-white/5 hover:bg-yellow-400 hover:text-black rounded-full flex items-center justify-center transition-all border border-white/10"
            >
              <span className="material-symbols-outlined text-4xl">arrow_back</span>
            </button>
          )}

          {/* The Image Container */}
          <div 
            className="relative max-w-5xl w-full max-h-full bg-white p-2 border-4 border-white shadow-2xl rotate-0 transition-transform duration-500"
            onClick={(e) => e.stopPropagation()}
          >
            <img 
              src={lesson.comic_pages[selectedComicIndex]} 
              className="w-full h-full object-contain"
              alt="Comic Zoom" 
            />
            <div className="absolute -bottom-4 -right-4 bg-yellow-400 border-2 border-black px-4 py-1 marker-font text-xl text-black">
               PAGE {selectedComicIndex + 1}
            </div>
          </div>

          {/* Navigation - Next */}
          {selectedComicIndex < lesson.comic_pages.length - 1 && (
            <button 
              onClick={nextComic}
              className="absolute right-4 md:right-10 z-10 w-16 h-16 bg-white/5 hover:bg-yellow-400 hover:text-black rounded-full flex items-center justify-center transition-all border border-white/10"
            >
              <span className="material-symbols-outlined text-4xl">arrow_forward</span>
            </button>
          )}
        </div>
      )}

      <style>{`
        .handwritten { font-family: 'Caveat', cursive; }
        .marker-font { font-family: 'Permanent Marker', cursive; }
        @keyframes beam-scan { 0% { top: 0%; opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { top: 100%; opacity: 0; } }
        .animate-beam-scan { animation: beam-scan 4s linear infinite; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
      `}</style>
    </div>
  );
};

export default NotesPage;

// END OF FILE: pages/NotesPage.tsx
// ==========================================================================

// FILE: pages/NoticeBoard.tsx
// --------------------------------------------------------------------------

import React, { useEffect, useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { supabase } from '../src/lib/supabase';

const NoticeBoard: React.FC = () => {
  const navigate = useNavigate();
  const [lessons, setLessons] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const fetchPublicLessons = async () => {
      try {
        const { data, error } = await supabase
          .from('lessons')
          .select('*, students(profile_image_url, full_name)')
          .eq('is_public', true)
          .order('created_at', { ascending: false });

        if (error) throw error;
        setLessons(data || []);
      } catch (err) {
        console.error("Error fetching notice board:", err);
      } finally {
        setLoading(false);
      }
    };

    fetchPublicLessons();
  }, []);

  if (loading) return (
    <div className="h-screen bg-[#3d2b1f] flex items-center justify-center">
      <div className="w-12 h-12 border-4 border-yellow-600 border-t-transparent rounded-full animate-spin" />
    </div>
  );

  return (
    // CHANGE 1: Switched from 'min-h-screen' to 'h-screen overflow-y-auto'.
    // This creates an internal scroll container that ignores the Body's 'overflow: hidden' lock.
    <div className="h-screen w-full overflow-y-auto bg-[#3d2b1f] font-sans relative">
      
      {/* Container for content with padding */}
      <div className="min-h-full p-6 md:p-16 lg:p-24">
        
        {/* Texture Overlay - Fixed relative to the viewport */}
        <div className="fixed inset-0 opacity-10 pointer-events-none z-0" style={{ backgroundImage: `url('https://www.transparenttextures.com/patterns/cork-board.png')` }} />

        <header className="max-w-7xl mx-auto mb-16 flex flex-col md:flex-row justify-between items-start md:items-end gap-6 relative z-10">
          <div className="animate-fade-in">
            <h1 className="marker-font text-6xl md:text-8xl text-yellow-500 uppercase tracking-tighter leading-none drop-shadow-lg">Notice Board</h1>
            <p className="handwritten text-xl md:text-3xl text-white/60 mt-4 max-w-xl italic">Public lectures shared by the Seeker community.</p>
          </div>
          <div className="flex gap-4">
            <button onClick={() => navigate('/archive')} className="px-8 py-4 bg-white/5 hover:bg-white/10 text-white rounded-2xl marker-font text-lg uppercase transition-all">My Lessons</button>
            <button onClick={() => navigate('/')} className="px-8 py-4 bg-yellow-600 text-white rounded-2xl marker-font text-lg uppercase shadow-2xl transition-all hover:scale-105">New Lesson</button>
          </div>
        </header>

        <div className="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-16 relative z-10 pb-24">
          {lessons.map((lesson) => (
            <div key={lesson.lesson_id} onClick={() => navigate(`/notes/${lesson.lesson_id}`)} className="notebook-wrapper group cursor-pointer">
              <div className="notebook-cover relative w-full aspect-[3/4.2] bg-[#fdfbf7] rounded-r-2xl shadow-2xl flex flex-col overflow-hidden border-l-[15px] border-black/10 transition-all duration-500 hover:-translate-y-2">

                {/* Image Banner Section */}
                <div className="h-[40%] w-full bg-gray-200 relative overflow-hidden">
                  <img src={lesson.banner_image} className="w-full h-full object-cover grayscale group-hover:grayscale-0 transition-all duration-700" alt="" />
                  <div className="absolute inset-0 bg-black/5" />
                </div>

                {/* Text Content Section */}
                <div className="flex-1 p-6 md:p-8 flex flex-col justify-between bg-[#fdfbf7]">
                  <div>
                    <div className="flex justify-between items-center mb-4">
                      <span className="text-[10px] font-black uppercase tracking-[0.3em] text-gray-400">
                        Shared {new Date(lesson.created_at).toLocaleDateString()}
                      </span>
                    </div>

                    {/* PROFILE IMAGE NEXT TO TITLE */}
                    <div className="flex items-start gap-4 group/title">
                      <h2 className="marker-font text-2xl md:text-3xl text-gray-800 leading-tight uppercase group-hover:text-yellow-700 transition-colors">
                        {lesson.title}
                      </h2>
                      <div className="shrink-0 mt-1">
                        {lesson.students?.profile_image_url ? (
                          <img
                            src={lesson.students.profile_image_url}
                            className="w-10 h-10 rounded-full border-2 border-white shadow-md object-cover ring-2 ring-yellow-500/20"
                            alt="Author"
                          />
                        ) : (
                          <div className="w-10 h-10 rounded-full bg-green-700 flex items-center justify-center text-white text-xs font-bold border-2 border-white shadow-md">
                            {lesson.students?.full_name?.substring(0, 1) || 'S'}
                          </div>
                        )}
                      </div>
                    </div>
                  </div>

                  <div className="border-t border-gray-100 pt-4">
                    <p className="handwritten text-lg text-gray-500 italic line-clamp-3">
                      {lesson.lesson_summary}
                    </p>
                  </div>
                </div>

                <div className="absolute left-0 top-0 bottom-0 w-4 bg-gradient-to-r from-black/5 to-transparent pointer-events-none" />
              </div>
            </div>
          ))}
        </div>
      </div>

      <style>{`
        .marker-font { font-family: 'Permanent Marker', cursive; }
        .handwritten { font-family: 'Caveat', cursive; }
        .notebook-wrapper { perspective: 1500px; }
        .notebook-cover { transform-origin: left center; }
        .notebook-wrapper:hover .notebook-cover {
           transform: rotateY(-8deg);
           box-shadow: -20px 30px 60px rgba(0,0,0,0.3);
        }
        
        /* Optional: Custom scrollbar styling to match the theme */
        ::-webkit-scrollbar {
          width: 10px;
        }
        ::-webkit-scrollbar-track {
          background: #3d2b1f; 
        }
        ::-webkit-scrollbar-thumb {
          background: #ca8a04; 
          border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb:hover {
          background: #eab308; 
        }
      `}</style>
    </div>
  );
};

export default NoticeBoard;

// END OF FILE: pages/NoticeBoard.tsx
// ==========================================================================

// FILE: pages/ProfilePage.tsx
// --------------------------------------------------------------------------

// FILE: pages/ProfilePage.tsx
// --------------------------------------------------------------------------

import React, { useEffect, useState } from 'react';
import { useUser } from '@clerk/clerk-react';
import { useNavigate } from 'react-router-dom';
import { supabase } from '../src/lib/supabase';
import { GoogleGenAI } from '@google/genai';

const TEXT_MODEL_NAME = 'gemini-3-pro-preview';
const IMAGE_MODEL_NAME = 'gemini-3-pro-image-preview';

// --- REMOTE ASSETS MAP ---
const BADGE_ASSETS: Record<string, { img: string; vid: string }> = {
  "deep_diver": {
    "img": "https://eifeyuvbxmsjjtbtbyuk.supabase.co/storage/v1/object/public/seeker/deep_diver.jpeg",
    "vid": "https://eifeyuvbxmsjjtbtbyuk.supabase.co/storage/v1/object/public/seeker/deep_diver.mp4"
  },
  "first_step": {
    "img": "https://eifeyuvbxmsjjtbtbyuk.supabase.co/storage/v1/object/public/seeker/first_step.jpeg",
    "vid": "https://eifeyuvbxmsjjtbtbyuk.supabase.co/storage/v1/object/public/seeker/first_step.mp4"
  },
  "night_scholar": {
    "img": "https://eifeyuvbxmsjjtbtbyuk.supabase.co/storage/v1/object/public/seeker/night_scholar.jpeg",
    "vid": "https://eifeyuvbxmsjjtbtbyuk.supabase.co/storage/v1/object/public/seeker/night_scholar.mp4"
  },
  "socratic_scholar": {
    "img": "https://eifeyuvbxmsjjtbtbyuk.supabase.co/storage/v1/object/public/seeker/socratic_scholar.jpeg",
    "vid": "https://eifeyuvbxmsjjtbtbyuk.supabase.co/storage/v1/object/public/seeker/socratic_scholar.mp4"
  },
  "streak": {
    "img": "https://eifeyuvbxmsjjtbtbyuk.supabase.co/storage/v1/object/public/seeker/streak.jpeg",
    "vid": "https://eifeyuvbxmsjjtbtbyuk.supabase.co/storage/v1/object/public/seeker/streak.mp4"
  }
};

// --- HELPER: Map Database Slugs to Asset Keys ---
const getBadgeAsset = (slug: string) => {
  if (slug === 'socratic_master') return BADGE_ASSETS['socratic_scholar'];
  if (slug === 'streak_3') return BADGE_ASSETS['streak'];
  // Default: assumes slug matches asset key exactly
  return BADGE_ASSETS[slug];
};

// --- GAMIFICATION & MATH HELPERS ---

const calculateLevel = (xp: number) => Math.floor(Math.sqrt(xp / 100)) + 1;

const getLevelThresholds = (level: number) => {
  const currentLevelBase = Math.pow(level - 1, 2) * 100;
  const nextLevelBase = Math.pow(level, 2) * 100;
  return { currentLevelBase, nextLevelBase };
};

const formatDateKey = (date: Date) => date.toISOString().split('T')[0];

const getReadableDate = (dateString: string) => {
  return new Date(dateString).toLocaleDateString('en-US', { 
    weekday: 'long', 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric' 
  });
};

const getIntensityClass = (count: number) => {
  if (count === 0) return 'bg-white/5';           
  if (count <= 1) return 'bg-green-900/40';       
  if (count <= 2) return 'bg-green-700/60';       
  if (count <= 4) return 'bg-green-500';          
  return 'bg-green-400 shadow-[0_0_8px_rgba(74,222,128,0.6)]'; 
};

// --- STATIC DATA OPTIONS ---

const LEVELS = ['Primary', 'High School', 'Undergraduate', 'Post-Grad', 'Professional'];
const STYLES = [
  { id: 'Diver', label: 'Deep Diver', desc: 'Context & History focused' },
  { id: 'Visualist', label: 'Visualist', desc: 'Maps & Imagery focused' },
  { id: 'Builder', label: 'Builder', desc: 'Project & Prototype focused' },
];
const PERSONAS = [
  { id: 'Professor', label: 'The Professor', desc: 'Formal & Rigorous' },
  { id: 'Mentor', label: 'The Mentor', desc: 'Supportive & Patient' },
  { id: 'Friend', label: 'The Friend', desc: 'Casual & Direct' },
];

// --- SKELETON LOADER COMPONENT ---

const ProfileSkeleton = () => (
  <div className="min-h-screen bg-[#1a1a1a] text-white p-6 md:p-20 overflow-y-auto font-sans animate-pulse">
    <div className="max-w-5xl mx-auto space-y-16 pb-20">
      <div className="flex flex-col md:flex-row justify-between items-end border-b border-white/10 pb-8 gap-6">
        <div className="flex-1 w-full space-y-4">
          <div className="flex items-center gap-4">
             <div className="h-12 w-64 bg-white/10 rounded-lg"></div>
             <div className="h-8 w-16 bg-yellow-400/20 rounded"></div>
          </div>
          <div className="w-full max-w-lg space-y-2">
             <div className="flex justify-between">
                <div className="h-3 w-24 bg-white/10 rounded"></div>
                <div className="h-3 w-24 bg-white/10 rounded"></div>
             </div>
             <div className="h-2 w-full bg-white/10 rounded-full"></div>
          </div>
        </div>
        <div className="flex gap-4">
            <div className="h-20 w-28 bg-white/5 rounded-2xl border border-white/5"></div>
            <div className="h-20 w-28 bg-white/5 rounded-2xl border border-white/5"></div>
        </div>
      </div>
      <div className="space-y-6">
         <div className="h-6 w-48 bg-white/10 rounded"></div>
         <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
            {[1,2,3,4,5].map(i => (
                <div key={i} className="h-32 bg-white/5 rounded-xl border border-white/5"></div>
            ))}
         </div>
      </div>
      <div className="h-64 bg-[#0c0c0c] rounded-3xl border border-white/10"></div>
    </div>
  </div>
);

// --- MAIN COMPONENT ---

const ProfilePage: React.FC = () => {
  const { user } = useUser();
  const navigate = useNavigate();
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);

  // Profile Data State
  const [profileData, setProfileData] = useState<{
    academicLevel: string;
    profession: string;
    learningStyle: string;
    teacherPersona: string;
    interests: string[];
    xp: number;
    earnedBadgeIds: Set<string>;
  }>({
    academicLevel: 'Undergraduate',
    profession: '',
    learningStyle: 'Visualist',
    teacherPersona: 'Mentor',
    interests: [],
    xp: 0,
    earnedBadgeIds: new Set()
  });

  const [allBadges, setAllBadges] = useState<any[]>([]);
  const [interestInput, setInterestInput] = useState('');

  // Heatmap Data State
  const [heatmapData, setHeatmapData] = useState<Record<string, number>>({});
  const [totalLessons, setTotalLessons] = useState(0);
  const [currentStreak, setCurrentStreak] = useState(0);

  // Daily Log Selection State
  const [selectedDate, setSelectedDate] = useState<string | null>(null);
  const [selectedLessons, setSelectedLessons] = useState<any[]>([]);
  const [loadingDay, setLoadingDay] = useState(false);

  // Recommendations State
  const [recommendations, setRecommendations] = useState<Array<{topic: string, image?: string}>>([]);
  const [loadingRecommendations, setLoadingRecommendations] = useState(false);

  // --- 1. INITIAL DATA FETCH (PARALLEL) ---
  useEffect(() => {
    if (!user) return;

    const loadAllData = async () => {
      setLoading(true);

      const oneYearAgo = new Date();
      oneYearAgo.setFullYear(new Date().getFullYear() - 1);

      const [profileResult, allBadgesResult, activityResult] = await Promise.all([
        supabase
          .from('students')
          .select('*, student_badges(badge_id)')
          .eq('student_id', user.id)
          .single(),
        
        supabase
          .from('badges')
          .select('*')
          .order('xp_reward', { ascending: true }),

        supabase
          .from('lessons')
          .select('created_at')
          .eq('student_id', user.id)
          .gte('created_at', oneYearAgo.toISOString())
      ]);

      if (profileResult.data) {
        const d = profileResult.data;
        const earnedIds = new Set(
          (d.student_badges || []).map((sb: any) => sb.badge_id)
        );
          
        setProfileData({
          academicLevel: d.academic_level || 'Undergraduate',
          profession: d.profession || '',
          learningStyle: d.learning_style_notes || 'Visualist',
          teacherPersona: d.teacher_persona || 'Mentor',
          interests: d.interest || [],
          xp: d.xp || 0,
          earnedBadgeIds: earnedIds as Set<string>
        });
      }

      if (allBadgesResult.data) {
        setAllBadges(allBadgesResult.data);
      }

      if (activityResult.data) {
        setTotalLessons(activityResult.data.length);
        const map: Record<string, number> = {};
        activityResult.data.forEach((l) => {
          const k = l.created_at.split('T')[0];
          map[k] = (map[k] || 0) + 1;
        });
        setHeatmapData(map);

        let streak = 0;
        const dateIterator = new Date();
        while (true) {
          const k = formatDateKey(dateIterator);
          if (map[k] && map[k] > 0) {
            streak++;
            dateIterator.setDate(dateIterator.getDate() - 1);
          } else {
            if (k === formatDateKey(new Date()) && streak === 0) {
              dateIterator.setDate(dateIterator.getDate() - 1);
              continue;
            }
            break;
          }
        }
        setCurrentStreak(streak);
        setSelectedDate(formatDateKey(new Date()));
      }

      setLoading(false);
    };

    loadAllData();
  }, [user]);

  // --- 2. DAILY DETAIL FETCH ---
  useEffect(() => {
    if (selectedDate && user) {
        const fetchDay = async () => {
            setLoadingDay(true);
            const start = new Date(selectedDate); start.setHours(0,0,0,0);
            const end = new Date(selectedDate); end.setHours(23,59,59,999);
            
            const { data } = await supabase
              .from('lessons')
              .select('*')
              .eq('student_id', user.id)
              .gte('created_at', start.toISOString())
              .lte('created_at', end.toISOString())
              .order('created_at', { ascending: false });
            
            setSelectedLessons(data || []);
            setLoadingDay(false);
        }
        fetchDay();
    }
  }, [selectedDate, user]);

  // --- 3. GENERATE RECOMMENDATIONS WHEN DATA LOADS ---
  useEffect(() => {
    if (!loading && user && profileData.interests.length > 0) {
      generateRecommendations();
    }
  }, [loading, profileData.interests]);

  // --- AI RECOMMENDATION GENERATION ---
  const generateRecommendations = async () => {
    setLoadingRecommendations(true);
    try {
      const ai = new GoogleGenAI({ apiKey: process.env.API_KEY || '' });

      const { data: recentLessons } = await supabase
        .from('lessons')
        .select('title')
        .eq('student_id', user?.id)
        .order('created_at', { ascending: false })
        .limit(5);

      const recentTopics = recentLessons?.map(l => l.title).join(', ') || 'None yet';

      const prompt = `You are an academic advisor for a student with the following profile:
**Interests:** ${profileData.interests.join(', ')}
**Academic Level:** ${profileData.academicLevel}
**Profession/Goal:** ${profileData.profession || 'Not specified'}
**Learning Style:** ${profileData.learningStyle}
**Recent Lessons:** ${recentTopics}

Based on this profile, recommend 6 specific, compelling lesson topics.
Return ONLY a JSON array of lesson titles (strings), nothing else. Example format:
["Advanced Quantum Entanglement", "The Ethics of AI Alignment"]`;

      const response = await ai.models.generateContent({
        model: TEXT_MODEL_NAME,
        contents: [{ role: 'user', parts: [{ text: prompt }] }]
      });

      const text = response.candidates?.[0]?.content?.parts?.[0]?.text;
      if (text) {
        const cleanJson = text.replace(/```json|```/g, '').trim();
        const topics = JSON.parse(cleanJson);
        
        const topicsWithImages = await Promise.all(
          topics.map(async (topic: string) => {
            try {
              const imagePrompt = `Educational illustration for "${topic}". Academic style, clean composition, isolated subject on pure white background. High quality, professional.`;
              
              const imageResponse = await ai.models.generateContent({
                model: IMAGE_MODEL_NAME,
                contents: [{ role: 'user', parts: [{ text: imagePrompt }] }]
              });

              const imagePart = imageResponse.candidates?.[0]?.content?.parts?.find(p => p.inlineData);
              const imageUrl = imagePart?.inlineData 
                ? `data:${imagePart.inlineData.mimeType};base64,${imagePart.inlineData.data}`
                : undefined;

              return { topic, image: imageUrl };
            } catch (err) {
              return { topic };
            }
          })
        );
        
        setRecommendations(topicsWithImages);
      }
    } catch (err) {
      console.error('Failed to generate recommendations:', err);
      setRecommendations([
        { topic: 'Introduction to Machine Learning' },
        { topic: 'Philosophy of Mind' },
        { topic: 'Data Structures & Algorithms' },
        { topic: 'Creative Writing Fundamentals' },
        { topic: 'Modern Physics Concepts' },
        { topic: 'Economic Game Theory' }
      ]);
    } finally {
      setLoadingRecommendations(false);
    }
  };

  // --- FORM HANDLERS ---
  const handleSave = async () => {
    if (!user) return;
    setSaving(true);
    const { error } = await supabase.from('students').update({
        academic_level: profileData.academicLevel,
        profession: profileData.profession,
        learning_style_notes: profileData.learningStyle,
        teacher_persona: profileData.teacherPersona,
        interest: profileData.interests,
        onboarding_finished: true 
    }).eq('student_id', user.id);
    setSaving(false);
    if (!error) {
      alert('Registry updated successfully.');
      if (profileData.interests.length > 0) {
        generateRecommendations();
      }
    }
  };

  const updateField = (field: string, val: any) => {
    setProfileData(prev => ({ ...prev, [field]: val }));
  };

  const addInterest = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter' && interestInput.trim()) {
      if (!profileData.interests.includes(interestInput.trim())) {
        updateField('interests', [...profileData.interests, interestInput.trim()]);
      }
      setInterestInput('');
    }
  };

  const removeInterest = (tag: string) => {
    updateField('interests', profileData.interests.filter(i => i !== tag));
  };

  const startRecommendedLesson = (topic: string) => {
    const lessonUuid = crypto.randomUUID();
    navigate(`/lesson/${lessonUuid}`, { state: { topic } });
  };

  // --- CALCULATIONS & RENDERERS ---
  const level = calculateLevel(profileData.xp);
  const { currentLevelBase, nextLevelBase } = getLevelThresholds(level);
  const progressPercent = Math.min(100, Math.max(0, ((profileData.xp - currentLevelBase) / (nextLevelBase - currentLevelBase)) * 100));

  const renderMonthLabels = () => {
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const labels = [];
    for(let i = 0; i < 12; i++) {
        const d = new Date(); 
        d.setMonth(d.getMonth() - 11 + i);
        labels.push(
            <span key={i} className="text-[10px] text-white/30 uppercase font-bold" style={{ width: '40px' }}>
                {months[d.getMonth()]}
            </span>
        );
    }
    return <div className="flex justify-between pl-8 mb-2 w-full max-w-[calc(53*14px)]">{labels}</div>;
  };

  const renderHeatmapSquares = () => {
    const squares = [];
    const daysToRender = 365;
    const startDate = new Date(); 
    startDate.setDate(startDate.getDate() - daysToRender);
    
    for (let i = 0; i < daysToRender; i++) {
        const current = new Date(startDate);
        current.setDate(startDate.getDate() + i);
        const dateKey = formatDateKey(current);
        const count = heatmapData[dateKey] || 0;
        const isSelected = selectedDate === dateKey;
        
        squares.push(
            <div 
                key={dateKey}
                onClick={() => setSelectedDate(dateKey)}
                title={`${count} lessons on ${current.toLocaleDateString()}`}
                className={`
                    w-[10px] h-[10px] sm:w-3 sm:h-3 rounded-[2px] cursor-pointer transition-all duration-200 
                    ${getIntensityClass(count)}
                    ${isSelected ? 'ring-2 ring-white scale-110 z-10' : 'hover:scale-125 hover:z-10'}
                `}
            />
        );
    }
    return squares;
  };

  if (loading) return <ProfileSkeleton />;

  return (
    <div className="min-h-screen bg-[#1a1a1a] text-white p-6 md:p-20 overflow-y-auto font-sans">
      <div className="max-w-5xl mx-auto space-y-16 pb-20">
        
        {/* HEADER: GAMIFIED STATS */}
        <header className="flex flex-col md:flex-row justify-between items-end border-b border-white/10 pb-8 gap-6 animate-fade-in">
          <div className="flex-1 w-full">
            <div className="flex items-baseline gap-4 mb-3">
               <h1 className="marker-font text-5xl md:text-7xl text-white uppercase tracking-tighter">Student Registry</h1>
               <div className="bg-yellow-400 text-black px-3 py-1 rounded text-xs font-black uppercase tracking-widest shadow-[0_0_15px_rgba(250,204,20,0.4)]">
                 Lvl {level}
               </div>
            </div>
            
            {/* XP BAR */}
            <div className="w-full max-w-lg">
                <div className="flex justify-between text-[10px] uppercase font-bold text-white/40 mb-1 tracking-wider">
                    <span>Progress to Level {level + 1}</span>
                    <span>{profileData.xp} / {nextLevelBase} XP</span>
                </div>
                <div className="h-2 w-full bg-white/10 rounded-full overflow-hidden border border-white/5">
                    <div 
                        className="h-full bg-gradient-to-r from-green-600 to-yellow-400 transition-all duration-1000 shadow-[0_0_10px_rgba(34,197,94,0.5)]" 
                        style={{ width: `${progressPercent}%` }} 
                    />
                </div>
            </div>
          </div>
          
          <div className="flex gap-4">
              <div className="bg-white/5 border border-white/10 px-6 py-3 rounded-2xl text-center min-w-[100px]">
                  <div className="text-2xl font-black text-green-400 marker-font">{currentStreak}</div>
                  <div className="text-[9px] uppercase tracking-widest text-white/40">Day Streak</div>
              </div>
              <div className="bg-white/5 border border-white/10 px-6 py-3 rounded-2xl text-center min-w-[100px]">
                  <div className="text-2xl font-black text-white marker-font">{totalLessons}</div>
                  <div className="text-[9px] uppercase tracking-widest text-white/40">Total Lessons</div>
              </div>
          </div>
        </header>

        {/* SECTION 1: HONORS & DISTINCTIONS (BADGES) - USING REMOTE S3 ASSETS */}
        <section className="space-y-6 animate-fade-in" style={{ animationDelay: '100ms' }}>
            <h2 className="text-xl font-bold uppercase tracking-widest text-white/40 border-b border-white/5 pb-2">I. Honors & Distinctions</h2>
            
            <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
                {allBadges.map((badge: any) => {
                    const isUnlocked = profileData.earnedBadgeIds.has(badge.id);
                    const asset = getBadgeAsset(badge.slug); // Using helper for mapping

                    return (
                        <div key={badge.id} className={`bg-white/5 border border-white/10 p-4 rounded-xl flex flex-col items-center text-center transition-all relative overflow-hidden group ${isUnlocked ? 'hover:bg-white/10' : ''}`}>
                            
                            {/* MEDIA CONTAINER */}
                            <div className={`w-24 h-24 mb-4 relative rounded-lg overflow-hidden flex items-center justify-center ${!isUnlocked ? 'opacity-50 grayscale' : ''}`}>
                                {asset ? (
                                    isUnlocked ? (
                                        // UNLOCKED: Loop the remote MP4
                                        <video 
                                            src={asset.vid} 
                                            autoPlay 
                                            loop 
                                            muted 
                                            playsInline 
                                            className="w-full h-full object-cover"
                                        />
                                    ) : (
                                        // LOCKED: Show remote Image
                                        <img 
                                            src={asset.img} 
                                            alt={badge.name} 
                                            className="w-full h-full object-cover"
                                        />
                                    )
                                ) : (
                                    // FALLBACK: If asset mapping missing
                                    <span className="material-symbols-outlined text-4xl text-white/20">{badge.icon}</span>
                                )}

                                {/* LOCKED CHAIN OVERLAY */}
                                {!isUnlocked && (
                                    <div className="absolute inset-0 z-20 flex items-center justify-center pointer-events-none bg-black/40">
                                        <div className="absolute w-[120%] h-1 bg-black/80 rotate-45 border-y border-white/20 shadow-xl"></div>
                                        <div className="absolute w-[120%] h-1 bg-black/80 -rotate-45 border-y border-white/20 shadow-xl"></div>
                                        <div className="w-8 h-8 bg-black rounded-full flex items-center justify-center border-2 border-white/20 z-30 shadow-2xl">
                                            <span className="material-symbols-outlined text-white/50 text-sm">lock</span>
                                        </div>
                                    </div>
                                )}
                            </div>

                            <h3 className={`font-bold uppercase text-[10px] tracking-widest mb-1 ${isUnlocked ? 'text-yellow-400' : 'text-white/60'}`}>{badge.name}</h3>
                            <p className="text-[9px] text-white/40 leading-tight line-clamp-2">{badge.description}</p>
                        </div>
                    );
                })}
            </div>
        </section>

        {/* SECTION 2: CLASS ATTENDANCE (HEATMAP) */}
        <section className="bg-[#0c0c0c] border border-white/10 rounded-3xl p-6 md:p-10 shadow-2xl relative overflow-hidden animate-fade-in" style={{ animationDelay: '200ms' }}>
            <h2 className="text-sm font-black uppercase text-white/40 tracking-widest mb-6 flex items-center gap-2">
                <span className="material-symbols-outlined text-sm">calendar_month</span>
                Class Attendance
            </h2>

            <div className="relative w-full overflow-x-auto pb-4 scrollbar-hide">
                {renderMonthLabels()}
                <div className="flex gap-2">
                    <div className="flex flex-col justify-between text-[9px] text-white/30 font-bold h-[calc(7*14px)] py-[2px] pr-2">
                        <span>Mon</span>
                        <span>Wed</span>
                        <span>Fri</span>
                    </div>
                    <div className="grid gap-[3px] sm:gap-1" style={{ gridTemplateRows: 'repeat(7, 1fr)', gridAutoFlow: 'column' }}>
                        {renderHeatmapSquares()}
                    </div>
                </div>
            </div>

            <div className="mt-4 flex justify-end items-center gap-2 text-[10px] text-white/30 uppercase tracking-widest">
                <span>Less</span>
                <div className="w-3 h-3 bg-white/5 rounded-[2px]" />
                <div className="w-3 h-3 bg-green-900/40 rounded-[2px]" />
                <div className="w-3 h-3 bg-green-700/60 rounded-[2px]" />
                <div className="w-3 h-3 bg-green-500 rounded-[2px]" />
                <div className="w-3 h-3 bg-green-400 rounded-[2px]" />
                <span>More</span>
            </div>

            <div className="w-full h-px bg-white/10 my-8" />

            {/* SUBSECTION: DAILY LOG */}
            <div className="animate-fade-in">
                <div className="flex justify-between items-center mb-6">
                    <div>
                        <h3 className="text-xl marker-font text-white uppercase">
                            {selectedDate ? getReadableDate(selectedDate) : 'Select a date'}
                        </h3>
                        <p className="text-xs text-white/40 uppercase tracking-widest mt-1">
                            {selectedLessons.length} Classes Attended
                        </p>
                    </div>
                    {loadingDay && <div className="w-6 h-6 border-2 border-green-500 border-t-transparent rounded-full animate-spin" />}
                </div>

                {selectedLessons.length === 0 ? (
                    <div className="text-center py-8 border-2 border-dashed border-white/5 rounded-2xl bg-white/[0.02]">
                        <p className="handwritten text-white/30 text-xl">No lectures attended on this date.</p>
                    </div>
                ) : (
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {selectedLessons.map((lesson) => (
                            <div key={lesson.lesson_id} className="group bg-white/5 hover:bg-white/10 border border-white/5 rounded-xl p-3 flex gap-4 items-center transition-all cursor-default">
                                <div className="w-16 h-16 shrink-0 rounded-lg overflow-hidden bg-black relative border border-white/10">
                                    {lesson.banner_image ? (
                                        <img src={lesson.banner_image} alt="Banner" className="w-full h-full object-cover opacity-60 group-hover:opacity-100 transition-opacity" />
                                    ) : (
                                        <div className="w-full h-full flex items-center justify-center bg-green-900/20 text-green-700 font-bold">A.I</div>
                                    )}
                                </div>
                                <div className="min-w-0">
                                    <h4 className="font-bold text-white truncate group-hover:text-yellow-400 transition-colors">{lesson.title}</h4>
                                    <p className="text-xs text-white/40 line-clamp-1 mt-0.5">{lesson.lesson_summary || "No summary available."}</p>
                                    <div className="flex items-center gap-2 mt-2">
                                        <span className="text-[9px] bg-white/10 px-1.5 py-0.5 rounded text-white/60 uppercase tracking-wider">Lesson</span>
                                        <span className="text-[9px] text-white/20 uppercase">{new Date(lesson.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                )}
            </div>
        </section>

        {/* SECTION 3: ACADEMIC IDENTITY FORM */}
        <section className="space-y-6 animate-fade-in" style={{ animationDelay: '300ms' }}>
          <h2 className="text-xl font-bold uppercase tracking-widest text-white/40 border-b border-white/5 pb-2">III. Academic Identity</h2>
          
          <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div className="space-y-3">
              <label className="text-xs font-black uppercase text-yellow-500 tracking-widest">Current Level</label>
              <div className="flex flex-wrap gap-2">
                {LEVELS.map(l => (
                  <button
                    key={l}
                    onClick={() => updateField('academicLevel', l)}
                    className={`px-5 py-3 rounded-xl text-xs font-black uppercase tracking-wider transition-all border ${profileData.academicLevel === l ? 'bg-white text-black border-white' : 'bg-transparent border-white/10 hover:border-white/30 text-white/60'}`}
                  >
                    {l}
                  </button>
                ))}
              </div>
            </div>

            <div className="space-y-3">
              <label className="text-xs font-black uppercase text-yellow-500 tracking-widest">Profession / Ambition</label>
              <input
                type="text"
                value={profileData.profession}
                onChange={(e) => updateField('profession', e.target.value)}
                placeholder="e.g. Quantum Physicist"
                className="w-full bg-white/5 border border-white/10 rounded-2xl px-6 py-4 focus:ring-2 focus:ring-yellow-400 outline-none transition-all text-lg font-serif"
              />
            </div>
          </div>
        </section>

        {/* SECTION 4: INTELLECTUAL CURIOSITIES */}
        <section className="space-y-6 animate-fade-in" style={{ animationDelay: '400ms' }}>
          <h2 className="text-xl font-bold uppercase tracking-widest text-white/40 border-b border-white/5 pb-2">IV. Intellectual Curiosities</h2>
          <div className="bg-white/5 rounded-3xl p-8 border border-white/10">
            
            {/* Instructional Header */}
            <div className="flex items-start gap-3 mb-6 p-4 bg-blue-500/5 border border-blue-500/20 rounded-xl">
              <span className="material-symbols-outlined text-blue-400 text-2xl shrink-0">info</span>
              <div className="flex-1">
                <h3 className="text-sm font-bold text-blue-400 uppercase tracking-wider mb-1">How This Works</h3>
                <p className="text-sm text-white/60 leading-relaxed">
                  Add topics you're passionate about or want to explore. These help personalize your lesson recommendations.
                </p>
              </div>
            </div>

            {/* Interest Tags Display */}
            {profileData.interests.length > 0 ? (
              <div className="flex flex-wrap gap-3 mb-6">
                {profileData.interests.map(tag => (
                  <span key={tag} className="group bg-gradient-to-r from-yellow-400 to-yellow-500 text-black pl-4 pr-3 py-2 rounded-lg text-sm font-bold flex items-center gap-2 uppercase tracking-wide shadow-lg hover:shadow-xl hover:scale-105 transition-all">
                    {tag}
                    <button 
                      onClick={() => removeInterest(tag)} 
                      className="hover:bg-black/20 rounded-full p-1 transition-all"
                      title="Remove interest"
                    >
                      <span className="material-symbols-outlined text-sm">close</span>
                    </button>
                  </span>
                ))}
              </div>
            ) : (
              <div className="mb-6 p-6 border-2 border-dashed border-white/10 rounded-2xl text-center">
                <span className="material-symbols-outlined text-white/20 text-4xl mb-2">psychology</span>
                <p className="text-white/40 handwritten text-xl">No interests added yet. Start by typing below!</p>
              </div>
            )}

            {/* Input Field */}
            <div className="relative">
              <div className="flex items-center gap-4 border-2 border-white/10 focus-within:border-yellow-400 transition-colors rounded-2xl px-6 py-4 bg-white/5 hover:bg-white/10">
                <span className="material-symbols-outlined text-yellow-400 text-2xl">add_circle</span>
                <input
                  type="text"
                  value={interestInput}
                  onChange={(e) => setInterestInput(e.target.value)}
                  onKeyDown={addInterest}
                  placeholder="Type a topic (e.g., Quantum Computing, Renaissance Art)..."
                  className="w-full bg-transparent outline-none text-xl placeholder:text-white/30 font-handwriting"
                />
                {interestInput.trim() && (
                  <span className="text-xs text-white/40 uppercase tracking-wider shrink-0">Press Enter</span>
                )}
              </div>
            </div>

            {/* Quick Suggestions */}
            {profileData.interests.length < 3 && (
              <div className="mt-4 flex items-center gap-2 flex-wrap">
                <span className="text-xs text-white/40 uppercase tracking-wider">Quick Add:</span>
                {['Machine Learning', 'Philosophy', 'Neuroscience', 'Game Theory'].map(suggestion => (
                  <button
                    key={suggestion}
                    onClick={() => {
                      if (!profileData.interests.includes(suggestion)) {
                        updateField('interests', [...profileData.interests, suggestion]);
                      }
                    }}
                    className="text-xs bg-white/5 hover:bg-white/10 border border-white/10 hover:border-yellow-400/50 px-3 py-1.5 rounded-lg transition-all"
                  >
                    + {suggestion}
                  </button>
                ))}
              </div>
            )}
          </div>
        </section>

        {/* NEW SECTION: PERSONALIZED RECOMMENDATIONS */}
        {profileData.interests.length > 0 && (
          <section className="space-y-6 animate-fade-in" style={{ animationDelay: '450ms' }}>
            <div className="flex justify-between items-end border-b border-white/5 pb-2">
              <h2 className="text-xl font-bold uppercase tracking-widest text-white/40">Recommended for You</h2>
              <button
                onClick={generateRecommendations}
                disabled={loadingRecommendations}
                className="text-xs bg-white/5 hover:bg-white/10 border border-white/10 px-4 py-2 rounded-lg transition-all flex items-center gap-2 disabled:opacity-50"
              >
                {loadingRecommendations ? (
                  <>
                    <div className="w-3 h-3 border-2 border-white/20 border-t-white rounded-full animate-spin" />
                    Generating...
                  </>
                ) : (
                  <>
                    <span className="material-symbols-outlined text-sm">refresh</span>
                    Refresh
                  </>
                )}
              </button>
            </div>

            {loadingRecommendations ? (
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {[1, 2, 3, 4, 5, 6].map(i => (
                  <div key={i} className="bg-white/5 rounded-2xl overflow-hidden border border-white/10 animate-pulse">
                    <div className="aspect-video bg-white/10" />
                    <div className="p-6">
                      <div className="h-4 bg-white/10 rounded mb-3 w-3/4"></div>
                      <div className="h-3 bg-white/10 rounded w-1/2"></div>
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {recommendations.map((rec, index) => (
                  <button
                    key={index}
                    onClick={() => startRecommendedLesson(rec.topic)}
                    className="group bg-gradient-to-br from-white/5 to-white/[0.02] hover:from-white/10 hover:to-white/5 border border-white/10 hover:border-yellow-400/50 rounded-2xl overflow-hidden text-left transition-all shadow-lg hover:shadow-2xl hover:-translate-y-1 relative"
                  >
                    <div className="aspect-video bg-gradient-to-br from-gray-900 to-gray-800 relative overflow-hidden">
                      {rec.image ? (
                        <>
                          <img 
                            src={rec.image} 
                            alt={rec.topic}
                            className="w-full h-full object-cover opacity-80 group-hover:opacity-100 group-hover:scale-105 transition-all duration-500"
                          />
                          <div className="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent" />
                        </>
                      ) : (
                        <div className="w-full h-full flex items-center justify-center">
                          <span className="material-symbols-outlined text-white/20 text-5xl">auto_stories</span>
                        </div>
                      )}
                      
                      <div className="absolute top-3 left-3 bg-black/60 backdrop-blur-sm px-3 py-1 rounded-lg border border-white/10">
                        <span className="text-[9px] uppercase tracking-widest text-white/80 font-bold">
                          Lesson {index + 1}
                        </span>
                      </div>
                    </div>

                    <div className="p-6 relative z-10">
                      <h3 className="text-lg font-bold text-white group-hover:text-yellow-400 transition-colors leading-tight mb-3">
                        {rec.topic}
                      </h3>
                      <div className="flex items-center gap-2 text-xs text-white/40 uppercase tracking-wider">
                        <span className="material-symbols-outlined text-sm">play_circle</span>
                        <span>Start Learning</span>
                      </div>
                    </div>
                  </button>
                ))}
              </div>
            )}
          </section>
        )}

        {/* SECTION 5: CLASSROOM PREFERENCES */}
        <section className="space-y-6 animate-fade-in" style={{ animationDelay: '500ms' }}>
          <h2 className="text-xl font-bold uppercase tracking-widest text-white/40 border-b border-white/5 pb-2">V. The Classroom</h2>
          
          <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div className="space-y-4">
              <label className="text-xs font-black uppercase text-yellow-500 tracking-widest">Learning Style</label>
              <div className="space-y-3">
                {STYLES.map(s => (
                  <button
                    key={s.id}
                    onClick={() => updateField('learningStyle', s.id)}
                    className={`w-full text-left p-5 rounded-2xl border-2 transition-all group ${profileData.learningStyle === s.id ? 'bg-yellow-400/10 border-yellow-400' : 'bg-white/5 border-transparent hover:bg-white/10'}`}
                  >
                    <div className="flex justify-between items-center mb-1">
                        <div className={`font-black uppercase tracking-widest ${profileData.learningStyle === s.id ? 'text-yellow-400' : 'text-white'}`}>{s.label}</div>
                        {profileData.learningStyle === s.id && <span className="material-symbols-outlined text-yellow-400 text-sm">check_circle</span>}
                    </div>
                    <div className="text-sm text-white/40 group-hover:text-white/60 transition-colors">{s.desc}</div>
                  </button>
                ))}
              </div>
            </div>

            <div className="space-y-4">
              <label className="text-xs font-black uppercase text-yellow-500 tracking-widest">Teacher Persona</label>
              <div className="space-y-3">
                {PERSONAS.map(p => (
                  <button
                    key={p.id}
                    onClick={() => updateField('teacherPersona', p.id)}
                    className={`w-full text-left p-5 rounded-2xl border-2 transition-all group ${profileData.teacherPersona === p.id ? 'bg-green-500/10 border-green-500' : 'bg-white/5 border-transparent hover:bg-white/10'}`}
                  >
                     <div className="flex justify-between items-center mb-1">
                        <div className={`font-black uppercase tracking-widest ${profileData.teacherPersona === p.id ? 'text-green-500' : 'text-white'}`}>{p.label}</div>
                        {profileData.teacherPersona === p.id && <span className="material-symbols-outlined text-green-500 text-sm">check_circle</span>}
                    </div>
                    <div className="text-sm text-white/40 group-hover:text-white/60 transition-colors">{p.desc}</div>
                  </button>
                ))}
              </div>
            </div>
          </div>
        </section>

        {/* FOOTER SAVE ACTION */}
        <div className="pt-8 border-t border-white/10 flex justify-between items-center">
          <p className="text-white/30 text-sm italic font-serif">"Update your registry to refine the AI's teaching model."</p>
          <button
            onClick={handleSave}
            disabled={saving}
            className="px-10 py-5 bg-white text-black font-black uppercase tracking-widest rounded-2xl hover:bg-yellow-400 transition-all shadow-xl disabled:opacity-50 flex items-center gap-3"
          >
            {saving && <div className="w-4 h-4 border-2 border-black border-t-transparent rounded-full animate-spin" />}
            {saving ? 'Saving...' : 'Save Changes'}
          </button>
        </div>

      </div>
    </div>
  );
};

export default ProfilePage;

// END OF FILE: pages/ProfilePage.tsx
// ==========================================================================

// FILE: pages/TestPage.tsx
// --------------------------------------------------------------------------

// pages/TestPage.tsx
import React, { useState, useEffect, useRef } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { GoogleGenAI, Type, FunctionDeclaration, Modality } from '@google/genai';
import { supabase } from '../src/lib/supabase';
import { createBlob, decode, decodeAudioData } from '../utils/audio';
import { awardXP } from '@/src/lib/gamification';
import { useUser } from '@clerk/clerk-react';

const submitGradeFn: FunctionDeclaration = {
  name: 'submit_grade',
  parameters: {
    type: Type.OBJECT,
    description: 'Call this ONLY to conclude the exam and provide the final grade.',
    properties: {
      score: { type: Type.NUMBER, description: 'Score 0-100' },
      feedback: { type: Type.STRING, description: 'Socratic feedback.' }
    },
    required: ['score', 'feedback']
  }
};

const TestPage = () => {
  const { lessonPlanId } = useParams();
  const navigate = useNavigate();
  const { user } = useUser();

  const [examState, setExamState] = useState<'idle' | 'active' | 'grading' | 'finished'>('idle');
  const [result, setResult] = useState<{ score: number, feedback: string } | null>(null);
  const [transcript, setTranscript] = useState<string>("");

  // Refs for Cleanup & Logic
  const sessionRef = useRef<any>(null);
  const streamRef = useRef<MediaStream | null>(null);
  const processorRef = useRef<ScriptProcessorNode | null>(null);
  const outAudioCtx = useRef<AudioContext | null>(null);
  const inAudioCtx = useRef<AudioContext | null>(null);

  // Audio Scheduling (Fixes the "30 voices" error)
  const nextStartTimeRef = useRef<number>(0);
  const activeSources = useRef<Set<AudioBufferSourceNode>>(new Set());
  const isSessionActive = useRef<boolean>(false);

  // DOCS REQUIREMENT: Clear audio on interruption
  const stopAllAudio = () => {
    activeSources.current.forEach(source => {
      try { source.stop(); } catch (e) { }
    });
    activeSources.current.clear();
    if (outAudioCtx.current) {
      nextStartTimeRef.current = outAudioCtx.current.currentTime;
    }
  };

  const cleanup = () => {
    isSessionActive.current = false;
    stopAllAudio();
    if (processorRef.current) {
      processorRef.current.disconnect();
      processorRef.current.onaudioprocess = null;
    }
    if (streamRef.current) streamRef.current.getTracks().forEach(t => t.stop());
    if (inAudioCtx.current?.state !== 'closed') inAudioCtx.current?.close();
    if (outAudioCtx.current?.state !== 'closed') outAudioCtx.current?.close();
    if (sessionRef.current) sessionRef.current.close();
  };

  const startSocraticExam = async () => {
    const { data: lessonData } = await supabase.from('lessons').select('ai_notes, title').eq('lesson_id', lessonPlanId).single();

    const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
    outAudioCtx.current = new AudioContext({ sampleRate: 24000 });
    inAudioCtx.current = new AudioContext({ sampleRate: 16000 });

    const session = await ai.live.connect({
      model: 'gemini-2.5-flash-native-audio-preview-12-2025',
      config: {
        responseModalities: [Modality.AUDIO],
        systemInstruction: `You are the Socratic Examiner. 
        TOPIC: ${lessonData?.title}. NOTES: ${lessonData?.ai_notes}.
        RULES: 
        1. SPEAK FIRST. Greet the student and ask the first question.
        2. Ask questions that challenge their logic.
        3. Call submit_grade when finished.`,
        tools: [{ functionDeclarations: [submitGradeFn] }],
      },
      callbacks: {
        onopen: () => {
          isSessionActive.current = true;
          setExamState('active');
          setupMicInput();
        },
        onmessage: async (m: any) => {
          // DOCS: Handle Interruption
          if (m.serverContent?.interrupted) {
            stopAllAudio();
            return;
          }

          // Handle Voice (The Scheduler)
          const audioB64 = m.serverContent?.modelTurn?.parts?.[0]?.inlineData?.data;
          if (audioB64 && outAudioCtx.current) {
            const buf = await decodeAudioData(decode(audioB64), outAudioCtx.current, 24000, 1);
            const source = outAudioCtx.current.createBufferSource();
            source.buffer = buf;
            source.connect(outAudioCtx.current.destination);

            // CHAINING: Prevents overlapping "30 voices"
            const now = outAudioCtx.current.currentTime;
            const startTime = Math.max(now, nextStartTimeRef.current);
            source.start(startTime);
            nextStartTimeRef.current = startTime + buf.duration;

            activeSources.current.add(source);
            source.onended = () => activeSources.current.delete(source);
          }

          if (m.serverContent?.outputTranscription) {
            setTranscript(m.serverContent.outputTranscription.text);
          }

          if (m.toolCall) {
            for (const fc of m.toolCall.functionCalls) {
              if (fc.name === 'submit_grade') finalizeExam(fc.args.score, fc.args.feedback);
            }
          }
        },
        onclose: () => cleanup()
      }
    });
    sessionRef.current = session;
  };

  const setupMicInput = async () => {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    streamRef.current = stream;
    const source = inAudioCtx.current!.createMediaStreamSource(stream);
    const processor = inAudioCtx.current!.createScriptProcessor(4096, 1, 1);
    processorRef.current = processor;

    processor.onaudioprocess = (e) => {
      // PREVENTS WEBSOCKET ERROR: Check if active before sending
      if (isSessionActive.current && sessionRef.current) {
        try {
          sessionRef.current.sendRealtimeInput({
            media: createBlob(e.inputBuffer.getChannelData(0))
          });
        } catch (err) { isSessionActive.current = false; }
      }
    };
    source.connect(processor);
    processor.connect(inAudioCtx.current!.destination);
  };

  // Inside finalizeExam in TestPage.tsx

  const finalizeExam = async (score: number, feedback: string) => {
    const passed = score > 50;

    if (passed) {
      // 1. Mark current lesson plan as completed
      await supabase.from('lesson_plans').update({ status: 'completed' }).eq('id', lessonPlanId);

      // 2. Unlock the NEXT lesson
      // First, get current lesson details
      const { data: current } = await supabase.from('lesson_plans').select('*').eq('id', lessonPlanId).single();

      if (current) {
        // Try to find next lesson in SAME module
        const { data: nextInModule } = await supabase
          .from('lesson_plans')
          .select('id')
          .eq('module_id', current.module_id)
          .eq('order_index', current.order_index + 1)
          .single();

        if (nextInModule) {
          await supabase.from('lesson_plans').update({ status: 'ready' }).eq('id', nextInModule.id);
        } else {
          // If no more lessons in module, try to find FIRST lesson of NEXT module
          const { data: currentMod } = await supabase.from('modules').select('*').eq('id', current.module_id).single();
          
          if (currentMod) {
             const { data: nextMod } = await supabase
              .from('modules')
              .select('id')
              .eq('course_id', currentMod.course_id)
              .eq('order_index', currentMod.order_index + 1)
              .single();

            if (nextMod) {
              const { data: firstInNextMod } = await supabase
                .from('lesson_plans')
                .select('id')
                .eq('module_id', nextMod.id)
                .order('order_index', { ascending: true })
                .limit(1)
                .single();

              if (firstInNextMod) {
                await supabase.from('lesson_plans').update({ status: 'ready' }).eq('id', firstInNextMod.id);
              }
            }
          }
        }
      }

      // 3. --- GAMIFICATION TRIGGER ---
      if (user) {
        try {
            // XP Calculation: Score * 2 (e.g. 100% = 200XP)
            const xpEarned = Math.round(score * 2);
            await awardXP(user.id, xpEarned);
            
            // Check for perfect score badge
            if (score === 100) {
                // You could add a checkSocraticMaster(user.id) here if you added that badge
            }
        } catch (e) {
            console.error("XP Award Failed:", e);
        }
      }

    } else {
      // Logic for failed exam
      await supabase.from('lesson_plans').update({ status: 'failed' }).eq('id', lessonPlanId);
    }

    // 4. Update UI State
    setResult({ score, feedback });
    setExamState('finished');
    
    // 5. Cleanup resources
    cleanup();
  };

  useEffect(() => { return () => cleanup(); }, []);

  return (
    <div className="h-screen w-full bg-[#0c1a14] flex flex-col items-center justify-center relative font-sans p-6">
      <div className="absolute inset-0 opacity-10 pointer-events-none bg-[url('https://www.transparenttextures.com/patterns/black-paper.png')]" />

      {examState === 'idle' && (
        <div className="text-center space-y-8 animate-fade-in z-10">
          <h1 className="marker-font text-6xl text-white uppercase tracking-tighter">The Socratic Exam</h1>
          <button onClick={startSocraticExam} className="px-16 py-6 bg-yellow-400 text-black rounded-2xl marker-font text-2xl uppercase shadow-2xl hover:scale-105 transition-all">Begin Examination</button>
        </div>
      )}

      {examState === 'active' && (
        <div className="text-center space-y-12 z-10">
          <div className="w-48 h-48 bg-yellow-400 rounded-full flex items-center justify-center animate-pulse mx-auto shadow-[0_0_80px_rgba(250,204,20,0.4)]">
            <span className="material-symbols-outlined text-6xl text-black">mic</span>
          </div>
          <div className="space-y-4">
            <h2 className="marker-font text-4xl text-white uppercase tracking-widest">Oral Exam In Progress</h2>
            <p className="handwritten text-2xl text-yellow-400/60 italic animate-pulse max-w-md mx-auto line-clamp-2">{transcript || "Waiting for the examiner to speak..."}</p>
          </div>
        </div>
      )}

      {examState === 'finished' && result && (
        <div className="z-20 max-w-2xl w-full bg-[#fdfbf7] rounded-[4rem] p-16 shadow-2xl text-center animate-fade-in border-l-[30px] border-black/5">
          <div className={`text-[12rem] leading-none marker-font ${result.score > 50 ? 'text-green-600' : 'text-red-600'}`}>{result.score}%</div>
          <div className="bg-black/5 p-8 rounded-3xl border-2 border-dashed border-black/10 my-8">
            <p className="handwritten text-2xl text-gray-700 leading-snug italic">"{result.feedback}"</p>
          </div>
          <button onClick={() => navigate(`/notes/${lessonPlanId}`)} className="w-full py-6 bg-black text-white rounded-2xl marker-font text-xl uppercase">Return to Library</button>
        </div>
      )}

      <style>{`
        .marker-font { font-family: 'Permanent Marker', cursive; }
        .handwritten { font-family: 'Caveat', cursive; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .animate-fade-in { animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
      `}</style>
    </div>
  );
};

export default TestPage;

// END OF FILE: pages/TestPage.tsx
// ==========================================================================

// FILE: pages/WelcomePage.tsx
// --------------------------------------------------------------------------

// FILE: pages/WelcomePage.tsx
// --------------------------------------------------------------------------

import React from 'react';
import { SignInButton } from '@clerk/clerk-react';

const WelcomePage: React.FC = () => {
  return (
    <div className="relative h-full w-full flex flex-col bg-[#1e3a2f] font-sans text-white overflow-y-auto selection:bg-yellow-400 selection:text-[#1e3a2f]">
      
      {/* 1. Chalkboard Texture & Glow Overlays */}
      <div 
        className="fixed inset-0 opacity-5 pointer-events-none z-0" 
        style={{ backgroundImage: `url('https://www.transparenttextures.com/patterns/black-paper.png')` }}
      />
      <div className="fixed inset-0 bg-radial-gradient from-transparent to-[#1e3a2f]/80 z-0" />
      
      {/* Glow Effects - Fixed positioning */}
      <div className="fixed top-1/4 -left-20 w-96 h-96 bg-yellow-400/5 rounded-full blur-[100px] pointer-events-none" />
      <div className="fixed bottom-1/4 -right-20 w-96 h-96 bg-yellow-400/5 rounded-full blur-[100px] pointer-events-none" />

      {/* 2. Navigation Header */}
      <header className="relative z-10 w-full px-6 lg:px-20 py-8 flex items-center justify-between max-w-7xl mx-auto shrink-0">
        <div className="flex items-center gap-3">
          <div className="bg-yellow-400 text-[#1e3a2f] p-2 rounded-lg shadow-lg">
            <span className="material-symbols-outlined text-2xl font-bold">school</span>
          </div>
          <h2 className="text-xl font-bold tracking-tight uppercase marker-font text-yellow-400">Seeker</h2>
        </div>
        
        <div className="flex items-center gap-8">
          <SignInButton mode="modal">
            <button className="bg-transparent border border-white/20 hover:border-yellow-400/50 px-6 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all">
              Sign In
            </button>
          </SignInButton>
        </div>
      </header>

      {/* 3. Hero Section */}
      <main className="relative z-10 flex-1 flex flex-col items-center justify-center px-6 text-center py-20 min-h-[600px]">
        <div className="max-w-3xl flex flex-col items-center animate-fade-in">
          
          {/* Central Scholar Icon */}
          <div className="mb-10 text-yellow-400">
            <span 
              className="material-symbols-outlined !text-[120px] drop-shadow-[0_0_30px_rgba(250,204,20,0.4)]"
              style={{ fontVariationSettings: "'FILL' 1" }}
            >
              auto_stories
            </span>
          </div>

          <div className="space-y-6 mb-12">
            <h1 className="text-5xl md:text-8xl font-bold tracking-tight text-white leading-[0.9] uppercase marker-font">
              Your Private<span className="text-yellow-400 italic">tutor</span> Awaits
            </h1>
            <p className="handwritten text-xl md:text-3xl text-white/60 max-w-xl mx-auto leading-relaxed italic">
              "What you seek is also seeking you." ‚Äî Step into a personalized realm of AI-driven mentorship.
            </p>
          </div>

          {/* CTA: Clerk Sign In Trigger */}
          <SignInButton mode="modal">
            <button className="group relative bg-yellow-400 text-[#1e3a2f] px-12 py-6 rounded-2xl text-xl font-black uppercase tracking-[0.2em] hover:scale-105 active:scale-95 transition-all shadow-[0_20px_50px_rgba(250,204,20,0.2)] flex items-center gap-4">
              <span>Enter Classroom</span>
              <span className="material-symbols-outlined group-hover:translate-x-2 transition-transform">arrow_forward</span>
            </button>
          </SignInButton> <br />

          {/* Est Date */}
          <div className="mt-16 flex items-center gap-6 opacity-20">
            <div className="h-[1px] w-12 bg-white" />
            <span className="text-[10px] tracking-[0.5em] uppercase font-black">Est. MMXXVI</span>
            <div className="h-[1px] w-12 bg-white" />
          </div>
        </div>
      </main>

      {/* 4. Features Grid */}
      <div className="relative z-10 w-full max-w-6xl mx-auto px-6 pb-20">
        <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
          <FeatureCard 
            icon="psychology" 
            title="Cognitive AI" 
            desc="An intelligence that adapts to your mental model and learning speed." 
          />
          {/* UPDATED CARD */}
          <FeatureCard 
            icon="record_voice_over" 
            title="1:1 Mentoring" 
            desc="Destroying the 'one size fits all' model of education through hyper-personalization." 
          />
          <FeatureCard 
            icon="shield_person" 
            title="Private Mentorship" 
            desc="A secure, data-private environment for your intellectual growth." 
          />
        </div>
      </div>

      {/* 5. Footer */}
      <footer className="relative z-10 w-full py-10 border-t border-white/5 bg-black/20 shrink-0">
        <div className="max-w-7xl mx-auto px-6 flex flex-col md:flex-row items-center justify-between gap-6">
          <p className="text-[10px] font-bold text-white/20 uppercase tracking-widest italic">
            ¬© 2026 Seeker. Pursue wisdom, endlessly.
          </p>
          <div className="flex items-center gap-8 text-[9px] font-black text-white/20 uppercase tracking-widest">
            <a href="#" className="hover:text-yellow-400 transition-colors">Privacy Policy</a>
            <a href="#" className="hover:text-yellow-400 transition-colors">Terms of Service</a>
            <a href="#" className="hover:text-yellow-400 transition-colors">Contact Support</a>
          </div>
        </div>
      </footer>
    </div>
  );
};

// Sub-component for clean cards
const FeatureCard = ({ icon, title, desc }: { icon: string, title: string, desc: string }) => (
  <div className="p-8 border border-white/10 rounded-3xl bg-white/5 backdrop-blur-md hover:bg-white/10 transition-all group border-b-4 border-b-transparent hover:border-b-yellow-400">
    <span className="material-symbols-outlined text-yellow-400 mb-4 text-3xl group-hover:scale-110 transition-transform">{icon}</span>
    <h3 className="marker-font text-white text-lg mb-2 uppercase tracking-tight">{title}</h3>
    <p className="handwritten text-white/40 text-lg leading-tight">{desc}</p>
  </div>
);

export default WelcomePage;

// END OF FILE: pages/WelcomePage.tsx
// ==========================================================================

// FILE: run.js
// --------------------------------------------------------------------------

import fs from 'fs';
import path from 'path';

// --- Configuration ---

// The name of the output file.
const outputFile = 'full_new_code.txt';

// The root directory of your project. '.' means the current directory.
const rootDir = '.';

// List of directories to completely ignore.
const ignoreDirs = [
  'node_modules',
  '.next',
  '.git',
  '.vscode',
  '.swc',
  'dist',
  'build',
  // Add any other directories you want to ignore
];

// List of specific files or file extensions to ignore.
const ignoreFiles = [
  outputFile,          // Don't include the output file itself
  'package-lock.json',
  'yarn.lock',
  'pnpm-lock.yaml',
  'tsconfig.tsbuildinfo',
  '.env',
  '.env.local',
  'bun.lockb'
  // Add any other specific files you want to ignore
];

const ignoreExtensions = [
    '.png', '.jpg', '.jpeg', '.gif', '.svg', '.ico', // Images
    '.woff', '.woff2', '.ttf', '.eot', // Fonts
    '.mp4', '.webm', // Videos
    '.zip', '.gz', // Archives
];

// --- Script Logic ---

let finalContent = '';

function walkDir(currentPath) {
  const files = fs.readdirSync(currentPath);

  for (const file of files) {
    const filePath = path.join(currentPath, file);
    const stat = fs.statSync(filePath);

    if (stat.isDirectory()) {
      // If it's a directory, check if it's in the ignore list.
      if (!ignoreDirs.includes(file)) {
        // If not ignored, recurse into it.
        walkDir(filePath);
      }
    } else {
      // It's a file. Check if it or its extension is in the ignore lists.
      const fileExtension = path.extname(file).toLowerCase();
      if (!ignoreFiles.includes(file) && !ignoreExtensions.includes(fileExtension)) {
        try {
          const content = fs.readFileSync(filePath, 'utf8');
          
          finalContent += `// FILE: ${filePath}\n`;
          finalContent += `// --------------------------------------------------------------------------\n\n`;
          finalContent += content;
          finalContent += `\n\n// END OF FILE: ${filePath}\n`;
          finalContent += `// ==========================================================================\n\n`;

        } catch (error) {
            // This can happen for binary files that aren't caught by the extension filter
            console.log(`Could not read file (likely binary): ${filePath}`);
        }
      }
    }
  }
}

try {
  console.log('Starting to bundle project files...');
  // Start the process from the root directory.
  walkDir(rootDir);

  // Write the aggregated content to the output file.
  fs.writeFileSync(outputFile, finalContent);

  console.log(`‚úÖ Successfully created ${outputFile}`);
  console.log('Remember to review the file for any sensitive information before sharing.');

} catch (error) {
  console.error('‚ùå An error occurred:', error);
}

// END OF FILE: run.js
// ==========================================================================

// FILE: src/lib/gamification.ts
// --------------------------------------------------------------------------

// FILE: src/lib/gamification.ts
// --------------------------------------------------------------------------
import { supabase } from './supabase';

// Level Formula: Level = sqrt(XP / 100)
export const calculateLevel = (xp: number) => {
  return Math.floor(Math.sqrt(xp / 100)) + 1;
};

export const getNextLevelXp = (currentLevel: number) => {
  return Math.pow(currentLevel, 2) * 100;
};

// Generic XP Awarder
export const awardXP = async (studentId: string, amount: number) => {
  const { data } = await supabase.from('students').select('xp').eq('student_id', studentId).single();
  const currentXp = data?.xp || 0;
  
  await supabase.from('students').update({ xp: currentXp + amount }).eq('student_id', studentId);
  return currentXp + amount;
};

const unlockBadge = async (studentId: string, badgeSlug: string) => {
  // 1. Get Badge Definition
  // Use maybeSingle() -> returns null if not found, doesn't throw error
  const { data: badge } = await supabase
    .from('badges')
    .select('id, xp_reward, name')
    .eq('slug', badgeSlug)
    .maybeSingle(); 

  if (!badge) {
    console.warn(`Badge definition not found for slug: ${badgeSlug}. Did you add it to the 'badges' table?`);
    return;
  }

  // 2. Check if user ALREADY has it
  const { data: existing } = await supabase
    .from('student_badges')
    .select('id')
    .eq('student_id', studentId)
    .eq('badge_id', badge.id)
    .maybeSingle(); // <--- This fixes Error PGRST116

  if (existing) {
    // User already has the badge. Do nothing.
    return; 
  }

  // 3. Award Badge (Safe Insert)
  // We try to insert. If it fails due to a race condition (Error 23505), we catch it.
  const { error } = await supabase
    .from('student_badges')
    .insert({ student_id: studentId, badge_id: badge.id });

  if (error) {
    // If error is "Duplicate Key" (23505), it means they earned it milliseconds ago. Ignore it.
    if (error.code === '23505') return;
    console.error("Error awarding badge:", error);
  } else {
    // Only award XP if the insert actually happened
    await awardXP(studentId, badge.xp_reward);
    console.log(`üéñÔ∏è Unlocked: ${badge.name}`);
  }
};


// --- BADGE CHECKERS ---

/**
 * Badge: NIGHT SCHOLAR
 * Logic: Checks if current time is between 10 PM (22:00) and 4 AM (04:00).
 * Trigger: Called after finishing a lesson in LessonPage.
 */
export const checkNightScholar = async (studentId: string) => {
  const hour = new Date().getHours();
  if (hour >= 22 || hour <= 4) {
    await unlockBadge(studentId, 'night_scholar');
  }
};

/**
 * Badge: INITIATE (First Step)
 * Logic: Checks if the user has exactly 1 lesson record in the 'lessons' table.
 * Trigger: Called after finishing a lesson in LessonPage.
 */
export const checkFirstStep = async (studentId: string) => {
  const { count } = await supabase
    .from('lessons')
    .select('*', { count: 'exact', head: true })
    .eq('student_id', studentId);

  // If this was their first lesson, count will be 1 (since we just inserted it)
  if (count === 1) {
    await unlockBadge(studentId, 'first_step');
  }
};

/**
 * Badge: SOCRATIC MASTER
 * Logic: Checks if the Exam Score was exactly 100%.
 * Trigger: Called after passing an exam in TestPage.
 */
export const checkSocraticMaster = async (studentId: string, score: number) => {
  if (score === 100) {
    await unlockBadge(studentId, 'socratic_master');
  }
};

/**
 * Badge: DEEP DIVER
 * Logic: Checks if the user has completed enough unique Lesson Plans (e.g., 15)
 * to constitute "5 Courses" worth of work (assuming avg 3 lessons/course).
 * Trigger: Called after passing an exam in TestPage.
 */
export const checkDeepDiver = async (studentId: string) => {
  const { count } = await supabase
    .from('lesson_plans')
    .select('*', { count: 'exact', head: true })
    .eq('status', 'completed'); // We rely on the lesson_plans table 'completed' status

  // Assuming ~3 lessons per course, 15 lessons = ~5 courses
  if (count && count >= 15) {
    await unlockBadge(studentId, 'deep_diver');
  }
};

/**
 * Badge: THE CONSTANT
 * Logic: Checks if calculated streak >= 7
 * Trigger: Called in ProfilePage after calculating logs
 */
export const checkStreakBadge = async (studentId: string, currentStreak: number) => {
  if (currentStreak >= 3) {
    await unlockBadge(studentId, 'streak_3');
  }
};

// END OF FILE: src/lib/gamification.ts
// ==========================================================================

// FILE: src/lib/supabase.ts
// --------------------------------------------------------------------------

import { createClient } from '@supabase/supabase-js';

const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY;

export const supabase = createClient(supabaseUrl, supabaseAnonKey);

// END OF FILE: src/lib/supabase.ts
// ==========================================================================

// FILE: tsconfig.json
// --------------------------------------------------------------------------

{
  "compilerOptions": {
    "target": "ES2022",
    "experimentalDecorators": true,
    "useDefineForClassFields": false,
    "module": "ESNext",
    "lib": [
      "ES2022",
      "DOM",
      "DOM.Iterable"
    ],
    "skipLibCheck": true,
    "types": [
      "node",
      "vite/client"
    ],
    "moduleResolution": "bundler",
    "isolatedModules": true,
    "moduleDetection": "force",
    "allowJs": true,
    "jsx": "react-jsx",
    "paths": {
      "@/*": [
        "./*"
      ]
    },
    "allowImportingTsExtensions": true,
    "noEmit": true
  }
}

// END OF FILE: tsconfig.json
// ==========================================================================

// FILE: types.ts
// --------------------------------------------------------------------------

// FILE: types.ts
// --------------------------------------------------------------------------

export enum TeacherStatus {
  IDLE = 'IDLE',
  CONNECTING = 'CONNECTING',
  TEACHING = 'TEACHING',
  ERROR = 'ERROR'
}

export interface QuizQuestion {
  question: string;
  options: string[];
  correctAnswerIndex: number;
}

export interface Quiz {
  title: string;
  questions: QuizQuestion[];
}

export interface GeneratedDiagram {
  url: string;
  topic: string;
}

export interface Message {
  role: 'user' | 'teacher';
  text: string;
  timestamp: number;
}

export interface BlackboardState {
  currentText: string;
  history: string[];
}


// END OF FILE: types.ts
// ==========================================================================

// FILE: upload-assets.js
// --------------------------------------------------------------------------

// upload-assets.js
import { createClient } from '@supabase/supabase-js';
import fs from 'fs';
import path from 'path';
import dotenv from 'dotenv';
import { fileURLToPath } from 'url';

// Load environment variables
dotenv.config({ path: '.env.local' });

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// CONFIGURATION
const SUPABASE_URL = process.env.VITE_SUPABASE_URL;
// Use SERVICE_ROLE_KEY for admin rights to upload, or VITE_SUPABASE_ANON_KEY if RLS allows uploads
const SUPABASE_KEY = process.env.SUPABASE_SERVICE_ROLE_KEY || process.env.VITE_SUPABASE_ANON_KEY; 
const BUCKET_NAME = 'seeker'; 
const ASSETS_DIR = './assets';

if (!SUPABASE_URL || !SUPABASE_KEY) {
  console.error('‚ùå Missing VITE_SUPABASE_URL or SUPABASE_SERVICE_ROLE_KEY in .env.local');
  process.exit(1);
}

const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

const mapToSlug = (filename) => {
  // Removes extension (e.g., 'deep_diver.mp4' -> 'deep_diver')
  return path.parse(filename).name;
};

async function uploadAndMap() {
  console.log(`üöÄ Starting upload to bucket: '${BUCKET_NAME}'...`);
  
  const files = fs.readdirSync(ASSETS_DIR).filter(file => 
    ['.jpeg', '.jpg', '.png', '.mp4', '.webm'].includes(path.extname(file).toLowerCase())
  );

  const assetMap = {};

  for (const file of files) {
    const filePath = path.join(ASSETS_DIR, file);
    const fileBuffer = fs.readFileSync(filePath);
    const slug = mapToSlug(file);
    const ext = path.extname(file).toLowerCase();
    const type = (ext === '.mp4' || ext === '.webm') ? 'vid' : 'img';

    console.log(`... Uploading ${file}`);

    // 1. Upload
    const { error } = await supabase.storage
      .from(BUCKET_NAME)
      .upload(`${file}`, fileBuffer, {
        upsert: true,
        contentType: type === 'vid' ? 'video/mp4' : 'image/jpeg'
      });

    if (error) {
      console.error(`‚ùå Error uploading ${file}:`, error.message);
      continue;
    }

    // 2. Get Public URL
    const { data } = supabase.storage
      .from(BUCKET_NAME)
      .getPublicUrl(`${file}`);

    // 3. Build Map
    if (!assetMap[slug]) assetMap[slug] = {};
    assetMap[slug][type] = data.publicUrl;
  }

  console.log('\n‚úÖ Upload Complete! Copy the code below into ProfilePage.tsx:\n');
  console.log('// --- REMOTE ASSETS MAP ---');
  console.log(`const BADGE_ASSETS: Record<string, { img: string; vid: string }> = ${JSON.stringify(assetMap, null, 2)};`);
}

uploadAndMap();

// END OF FILE: upload-assets.js
// ==========================================================================

// FILE: utils/audio.ts
// --------------------------------------------------------------------------


export function decode(base64: string): Uint8Array {
  const binaryString = atob(base64);
  const len = binaryString.length;
  const bytes = new Uint8Array(len);
  for (let i = 0; i < len; i++) {
    bytes[i] = binaryString.charCodeAt(i);
  }
  return bytes;
}

export function encode(bytes: Uint8Array): string {
  let binary = '';
  const len = bytes.byteLength;
  for (let i = 0; i < len; i++) {
    binary += String.fromCharCode(bytes[i]);
  }
  return btoa(binary);
}

export async function decodeAudioData(
  data: Uint8Array,
  ctx: AudioContext,
  sampleRate: number,
  numChannels: number,
): Promise<AudioBuffer> {
  const dataInt16 = new Int16Array(data.buffer);
  const frameCount = dataInt16.length / numChannels;
  const buffer = ctx.createBuffer(numChannels, frameCount, sampleRate);

  for (let channel = 0; channel < numChannels; channel++) {
    const channelData = buffer.getChannelData(channel);
    for (let i = 0; i < frameCount; i++) {
      channelData[i] = dataInt16[i * numChannels + channel] / 32768.0;
    }
  }
  return buffer;
}

export function createBlob(data: Float32Array): { data: string; mimeType: string } {
  const l = data.length;
  const int16 = new Int16Array(l);
  for (let i = 0; i < l; i++) {
    int16[i] = data[i] * 32768;
  }
  return {
    data: encode(new Uint8Array(int16.buffer)),
    mimeType: 'audio/pcm;rate=16000',
  };
}


// END OF FILE: utils/audio.ts
// ==========================================================================

// FILE: vite-env.d.ts
// --------------------------------------------------------------------------

/// <reference types="vite/client" />

interface ImportMetaEnv {
  readonly VITE_CLERK_PUBLISHABLE_KEY: string
  // add more env variables here as needed
}

interface ImportMeta {
  readonly env: ImportMetaEnv
}

// END OF FILE: vite-env.d.ts
// ==========================================================================

// FILE: vite.config.ts
// --------------------------------------------------------------------------

import path from 'path';
import { defineConfig, loadEnv } from 'vite';
import react from '@vitejs/plugin-react';

export default defineConfig(({ mode }) => {
    const env = loadEnv(mode, '.', '');
    return {
      server: {
        port: 3000,
        host: '0.0.0.0',
      },
      plugins: [react()],
      define: {
        'process.env.API_KEY': JSON.stringify(env.GEMINI_API_KEY),
        'process.env.GEMINI_API_KEY': JSON.stringify(env.GEMINI_API_KEY)
      },
      resolve: {
        alias: {
          '@': path.resolve(__dirname, '.'),
        }
      }
    };
});


// END OF FILE: vite.config.ts
// ==========================================================================

